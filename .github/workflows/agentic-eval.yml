name: Agentic Evaluation Analysis

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to take'
        default: 'analyze'
        type: choice
        options:
          - analyze
          - quick-test
          - full-eval
      dataset:
        description: 'Dataset to evaluate'
        default: 'phase-1'
        type: choice
        options:
          - phase-1
          - phase-2
          - all
      pipelines:
        description: 'Pipelines to analyze/test (comma-separated)'
        default: 'standard,graph,quantitative,orchestrator'
        type: string
      max_questions:
        description: 'Max questions per pipeline (for full-eval)'
        default: '50'
        type: string
      label:
        description: 'Label for this evaluation run'
        default: ''
        type: string
  # Run after the main eval workflow completes
  workflow_run:
    workflows: ["RAG Evaluation Pipeline"]
    types: [completed]

env:
  SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
  PINECONE_HOST: ${{ secrets.PINECONE_HOST }}
  NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
  N8N_HOST: https://amoret.app.n8n.cloud

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ github.event.inputs.action == 'analyze' || github.event_name == 'workflow_run' }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Analyze latest results
        id: analysis
        run: |
          python3 eval/analyzer.py --output-summary >> $GITHUB_STEP_SUMMARY

      - name: Create issue if regressions found
        if: steps.analysis.outputs.has_regressions == 'true'
        run: |
          gh issue create \
            --title "Regression detected in iteration $(cat /tmp/iter_num)" \
            --body "$(cat /tmp/regression_report.md)" \
            --label "regression,automated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  quick-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.inputs.action == 'quick-test' }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run quick endpoint tests
        run: |
          python3 eval/quick-test.py \
            --pipelines "${{ inputs.pipelines }}" \
            --questions 3

      - name: Commit quick test results
        run: |
          git config user.name "agentic-eval[bot]"
          git config user.email "agentic-eval[bot]@users.noreply.github.com"
          git add docs/data.json
          git diff --staged --quiet || (git commit -m "quick-test: endpoint smoke test results" && git push)

  full-eval:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: ${{ github.event.inputs.action == 'full-eval' }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run full evaluation
        run: |
          cd eval
          DATASET="${{ inputs.dataset || 'phase-1' }}"
          LABEL="${{ inputs.label || '' }}"
          ARGS="--dataset $DATASET --types ${{ inputs.pipelines }} --max ${{ inputs.max_questions }} --reset"
          if [ -n "$LABEL" ]; then
            ARGS="$ARGS --label \"$LABEL\""
          fi
          python run-eval-parallel.py $ARGS

      - name: Commit results
        run: |
          git config user.name "agentic-eval[bot]"
          git config user.email "agentic-eval[bot]@users.noreply.github.com"
          git add docs/data.json docs/tested-questions.json logs/
          git diff --staged --quiet || (git commit -m "eval: full evaluation (${{ inputs.dataset || 'phase-1' }}, ${{ inputs.pipelines }})" && git push)

      - name: Run analysis
        run: |
          python3 eval/analyzer.py --output-summary >> $GITHUB_STEP_SUMMARY
