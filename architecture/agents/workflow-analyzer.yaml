# AGENT 1 - WORKFLOW ANALYZER
# Modèle: Opus 4.5 (analyse complexe)

name: workflow-analyzer
model: opus-4.5
version: "1.0"

description: |
  Analyse approfondie des workflows n8n existants.
  Peut repenser l'architecture complètement pour qu'elle soit state of the art.

system_prompt: |
  Tu es un expert en workflows n8n et architecture RAG/LLM state of the art.

  TON ROLE:
  - Analyser chaque workflow JSON en détail
  - Identifier les problèmes et améliorations possibles
  - Déterminer si les patchs présents dans les documents sont suffisants et pertinents
  - Proposer une architecture state of the art si nécessaire
  - Produire un rapport détaillé

  DOCUMENTS ACCESSIBLES:
  - Best practices n8n
  - Patchs correctifs proposés
  - Documents d'analyse
  - Tous les workflows JSON

  CRITÈRES D'ANALYSE:
  1. Performance
     - Timeouts appropriés
     - Parallélisation possible
     - Gestion mémoire
     - Batch processing

  2. Résilience
     - Error handling
     - Retries
     - Fallbacks
     - Circuit breakers

  3. Sécurité
     - Validation inputs
     - Sanitization
     - Credentials handling
     - Rate limiting

  4. Maintenabilité
     - Nommage clair
     - Documentation inline
     - Modularité
     - Testabilité

  5. Architecture
     - Séparation des concerns
     - Cohérence inter-workflows
     - Patterns utilisés
     - Évolutivité

  FORMAT DU RAPPORT:
  Pour chaque workflow:
  ```json
  {
    "workflow": "nom.json",
    "score": 0-100,
    "issues": [
      {
        "severity": "critical|high|medium|low",
        "category": "performance|resilience|security|maintainability|architecture",
        "node": "node_name",
        "description": "...",
        "recommendation": "...",
        "effort": "easy|medium|hard"
      }
    ],
    "architecture_recommendations": "...",
    "priority_actions": ["..."]
  }
  ```

n8n_community_nodes_required:
  # Packages npm a installer via Settings > Community Nodes
  # -- Vector / Graph --
  - n8n-nodes-neo4j               # Neo4j vector store + Cypher queries (by Kurea, v0.2.2)
  - n8n-nodes-neo4j-extended      # Extended Neo4j: vector search, graph ops, AI tools
  # -- Storage --
  - "@winth03/n8n-nodes-minio"    # MinIO/S3 compatible high-perf storage
  # -- Document Processing --
  - n8n-nodes-docxtemplater       # Word document templating (DOCX/PPTX/XLSX)
  - n8n-docx-converter            # DOCX text extraction for RAG ingestion
  - n8n-nodes-pdf-page-extract    # Per-page PDF extraction
  # -- Redis Enhanced --
  - "@codingfrog/n8n-nodes-redis-enhanced"  # 35+ Redis ops: TTL, pub/sub, Lua, sets
  - n8n-redis-anyway              # Cache with expiration + conditional routing
  # -- MCP --
  - n8n-nodes-mcp                 # MCP client for external tool servers

n8n_builtin_nodes_used:
  # Nodes LangChain integres dans n8n 1.x+ (70+ AI nodes)
  # -- AI / Agents --
  - "@n8n/n8n-nodes-langchain.chatTrigger"         # Chat interface
  - "@n8n/n8n-nodes-langchain.agent"               # AI Agent (ReAct) orchestration
  - "@n8n/n8n-nodes-langchain.chainLlm"            # Basic LLM Chain
  - "@n8n/n8n-nodes-langchain.toolWorkflow"        # Sub-workflow as Agent Tool
  # -- LLM Providers --
  - "@n8n/n8n-nodes-langchain.lmChatAnthropic"     # Claude 3/3.5/4 integration
  - "@n8n/n8n-nodes-langchain.lmChatOpenAi"        # OpenAI GPT-4o/o1/o3 integration
  - "@n8n/n8n-nodes-langchain.lmChatGoogleGemini"  # Google Gemini 2.0
  - "@n8n/n8n-nodes-langchain.lmChatOllama"        # Local LLMs via Ollama
  # -- Embeddings --
  - "@n8n/n8n-nodes-langchain.embeddingsOpenAi"    # text-embedding-3-small/large
  - "@n8n/n8n-nodes-langchain.embeddingsCohere"    # Cohere embed models
  - "@n8n/n8n-nodes-langchain.embeddingsOllama"    # Local embeddings
  # -- Vector Stores --
  - "@n8n/n8n-nodes-langchain.vectorStorePinecone" # Pinecone vector store
  - "@n8n/n8n-nodes-langchain.vectorStoreSupabase" # Supabase/pgvector
  - "@n8n/n8n-nodes-langchain.vectorStoreRedis"    # Redis vector store
  # -- Memory --
  - "@n8n/n8n-nodes-langchain.memoryRedis"         # Redis chat memory
  - "@n8n/n8n-nodes-langchain.memoryPostgres"      # Postgres chat memory
  # -- Infrastructure --
  - n8n-nodes-base.redis                           # Redis caching/locks
  - n8n-nodes-base.postgres                        # Supabase/PostgreSQL
  - n8n-nodes-base.awsS3                           # AWS S3 storage
  - n8n-nodes-base.s3                              # S3-compatible storage
  - n8n-nodes-base.httpRequest                     # HTTP/REST calls
  - n8n-nodes-base.code                            # JavaScript/Python code
  - n8n-nodes-base.executeWorkflow                 # Sub-workflow calls

reference_documents:
  - "ARCHITECTURE_FINALE_SOTA_2026.md"
  - "ARCHITECTURE_FINALE_SOTA_2026_COMPLEMENTAIRE 3.md"
  - "architecture/PLAN_MASTER.md"                   # Architecture plan
  - "architecture/docs/SOTA-2026-MISSING-PATTERNS.md" # Patterns manquants (Agentic RAG, Reranking, etc.)

security_advisory:
  # CVE-2026-21858 (CVSS 10.0) "Ni8mare" - affecte n8n < v1.65.0
  # Exploite Content-Type confusion pour extraction de secrets sans authentification
  # CORRIGE dans n8n v1.121.0 (18 Nov 2025)
  # ACTION: Verifier que l'instance n8n est >= v1.121.0
  min_n8n_version: "1.121.0"

mcp_access:
  - read: github
  - read: n8n (metadata only)

inputs:
  - path: "*.json"
    description: "Tous les workflows n8n"
  - path: "docs/best-practices.md"
    description: "Best practices"
  - path: "config/stack.yaml"
    description: "Stack technique"

outputs:
  - file: analysis-report.json
    format: json
    description: "Rapport complet d'analyse"

  - file: architecture-recommendations.md
    format: markdown
    description: "Recommandations architecture globale"
