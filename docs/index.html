<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-RAG Orchestrator — SOTA 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
:root{--bg:#0a0e14;--s1:#10151d;--s2:#151b26;--s3:#1c2330;--s4:#232b3a;--bd:#2a3344;--tx:#dce4f0;--tx2:#8896a8;--tx3:#556070;--ac:#4f8efa;--ac2:#3a70d4;--gn:#2dd47a;--gn2:#1fa55e;--gn-bg:rgba(45,212,122,.08);--rd:#f05555;--rd2:#c83838;--rd-bg:rgba(240,85,85,.08);--yl:#e8b820;--yl-bg:rgba(232,184,32,.08);--or:#f08030;--pp:#a060f0;--cy:#20c0d8;--mg:#e060a0;--r:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:'Inter',system-ui,sans-serif;font-size:13px;line-height:1.55}
::selection{background:var(--ac);color:#fff}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
code,.mono{font-family:'JetBrains Mono',monospace;font-size:.9em}
a{color:var(--ac);text-decoration:none}a:hover{text-decoration:underline}
h2{font-size:18px;font-weight:700;margin-bottom:16px;letter-spacing:-.02em}
h3{font-size:11.5px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);margin-bottom:10px}

/* Layout */
.header{background:var(--s1);border-bottom:1px solid var(--bd);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header h1{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
.header .meta{display:flex;gap:14px;align-items:center;font-size:11.5px;color:var(--tx2)}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.dot.ok{background:var(--gn);box-shadow:0 0 6px var(--gn)}.dot.run{background:var(--yl);animation:blink 1.5s infinite}.dot.err{background:var(--rd)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bd);padding:0 20px;overflow-x:auto;gap:0}
.tab{padding:10px 18px;font-size:12px;font-weight:600;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:.15s}
.tab:hover{color:var(--tx2)}.tab.active{color:var(--ac);border-color:var(--ac)}
.panel{display:none;padding:20px 24px;max-width:1600px;margin:0 auto}.panel.active{display:block}

/* Cards */
.card{background:var(--s2);border:1px solid var(--bd);border-radius:var(--r);padding:16px;overflow:hidden}
.card-accent{border-left:3px solid var(--ac)}
.grid{display:grid;gap:12px;margin:12px 0}
.g5{grid-template-columns:repeat(5,1fr)}.g4{grid-template-columns:repeat(4,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g2{grid-template-columns:1fr 1fr}
.g1-2{grid-template-columns:1fr 2fr}.g2-1{grid-template-columns:2fr 1fr}.g1-3{grid-template-columns:1fr 3fr}

/* Stats */
.stat{text-align:center;padding:12px 8px}
.stat .v{font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1.1}
.stat .l{font-size:11px;color:var(--tx2);margin-top:4px}
.stat .d{font-size:11px;font-weight:600;margin-top:2px}
.d-up{color:var(--gn)}.d-dn{color:var(--rd)}.d-fl{color:var(--tx3)}

/* Tags */
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.03em}
.t-pass{background:var(--gn-bg);color:var(--gn)}.t-fail{background:var(--rd-bg);color:var(--rd)}.t-err{background:var(--yl-bg);color:var(--yl)}.t-skip{background:rgba(78,90,109,.12);color:var(--tx3)}
.t-p1{background:rgba(79,142,250,.12);color:var(--ac)}.t-p2{background:rgba(160,96,240,.12);color:var(--pp)}.t-p3{background:rgba(32,192,216,.12);color:var(--cy)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:12px}
th{text-align:left;padding:8px 10px;background:var(--s3);color:var(--tx2);font-weight:600;font-size:10.5px;text-transform:uppercase;letter-spacing:.05em;position:sticky;top:0;z-index:2}
td{padding:6px 10px;border-top:1px solid var(--bd)}
tr:hover td{background:rgba(255,255,255,.015)}
tr.expandable{cursor:pointer}

/* Progress bars */
.pbar{height:6px;background:var(--s3);border-radius:3px;overflow:hidden;position:relative}
.pbar .fill{height:100%;border-radius:3px;transition:width .4s}.pbar .marker{position:absolute;top:-2px;height:10px;width:2px;background:var(--tx2);border-radius:1px}
.pbar-lg{height:10px}

/* Gauge */
.gauge{position:relative;width:100px;height:100px;margin:0 auto}
.gauge svg{transform:rotate(-90deg)}.gauge circle{fill:none;stroke-linecap:round}
.gauge .bg{stroke:var(--s3);stroke-width:6}.gauge .fg{stroke-width:6;transition:stroke-dashoffset .6s}
.gauge .val{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace}
.gauge .lbl{text-align:center;font-size:10px;color:var(--tx2);margin-top:4px;text-transform:uppercase;letter-spacing:.04em}

/* Phase timeline */
.phase-line{display:flex;gap:4px;margin:16px 0}
.phase-dot{flex:1;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:1px solid var(--bd);color:var(--tx3);background:var(--s2);transition:.2s;position:relative}
.phase-dot.current{background:var(--ac);color:#fff;border-color:var(--ac);box-shadow:0 0 12px rgba(79,142,250,.3)}
.phase-dot.done{background:var(--gn2);color:#fff;border-color:var(--gn2)}
.phase-dot.locked{opacity:.5}

/* Search / Filters */
.filters{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.filters input,.filters select{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:7px 12px;color:var(--tx);font-size:12px;outline:none}
.filters input:focus,.filters select:focus{border-color:var(--ac)}
.filters input{flex:1;min-width:200px}

/* Copy button */
.copy-btn{background:var(--s3);border:1px solid var(--bd);color:var(--tx2);padding:3px 10px;border-radius:4px;cursor:pointer;font-size:11px;font-family:'JetBrains Mono',monospace}
.copy-btn:hover{background:var(--ac);color:#fff;border-color:var(--ac)}
.copy-btn.copied{background:var(--gn);color:#fff;border-color:var(--gn)}

/* Code block */
.code-block{background:var(--s1);border:1px solid var(--bd);border-radius:6px;padding:12px 16px;font-family:'JetBrains Mono',monospace;font-size:12px;overflow-x:auto;white-space:pre;line-height:1.6;position:relative}
.code-block .copy-btn{position:absolute;top:8px;right:8px}

/* Collapsible */
details{margin:8px 0}
details>summary{cursor:pointer;padding:8px 12px;background:var(--s3);border:1px solid var(--bd);border-radius:6px;font-size:12px;font-weight:600;list-style:none}
details>summary::before{content:'\25B6';margin-right:8px;font-size:10px;transition:.2s}
details[open]>summary::before{transform:rotate(90deg)}
details>summary:hover{background:var(--s4)}
details .detail-content{padding:12px;border:1px solid var(--bd);border-top:none;border-radius:0 0 6px 6px;background:var(--s2)}

/* Responsive */
@media(max-width:1200px){.g4,.g5{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:1fr 1fr}}
@media(max-width:768px){.g4,.g5,.g3,.g2{grid-template-columns:1fr}.g1-2,.g2-1,.g1-3{grid-template-columns:1fr}.tabs{gap:0}.tab{padding:8px 12px;font-size:11px}}

/* Node map */
.node{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;font-size:10.5px;font-weight:600;margin:2px;border:1px solid var(--bd)}
.node-trigger{background:rgba(79,142,250,.12);border-color:rgba(79,142,250,.3);color:var(--ac)}
.node-code{background:rgba(232,184,32,.08);border-color:rgba(232,184,32,.2);color:var(--yl)}
.node-http{background:rgba(45,212,122,.08);border-color:rgba(45,212,122,.2);color:var(--gn)}
.node-db{background:rgba(160,96,240,.08);border-color:rgba(160,96,240,.2);color:var(--pp)}
.node-ai{background:rgba(240,96,160,.08);border-color:rgba(240,96,160,.2);color:var(--mg)}
.node-merge{background:rgba(32,192,216,.08);border-color:rgba(32,192,216,.2);color:var(--cy)}
.node-if{background:rgba(240,128,48,.08);border-color:rgba(240,128,48,.2);color:var(--or)}

/* Blockers */
.blocker{background:var(--rd-bg);border:1px solid rgba(240,85,85,.2);border-radius:6px;padding:10px 14px;margin:4px 0}
.blocker .priority{font-size:10px;font-weight:800;padding:1px 6px;border-radius:3px;background:var(--rd);color:#fff;margin-right:6px}
</style>
</head>
<body>

<div class="header">
  <h1><span class="dot" id="hd-dot"></span> Multi-RAG Orchestrator <span style="color:var(--tx3);font-weight:400">SOTA 2026</span></h1>
  <div class="meta">
    <span id="hd-phase"></span>
    <span id="hd-iter"></span>
    <span id="hd-qs"></span>
    <span id="hd-ts"></span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="exec">Executive Summary</div>
  <div class="tab" data-tab="focus">Focus</div>
  <div class="tab" data-tab="questions">Questions</div>
  <div class="tab" data-tab="workflows">Workflows</div>
  <div class="tab" data-tab="databases">Databases</div>
  <div class="tab" data-tab="costs">Costs & Models</div>
  <div class="tab" data-tab="agent">AI Agent</div>
</div>

<!-- ============ TAB 1: EXECUTIVE SUMMARY ============ -->
<div class="panel active" id="p-exec">
  <h2>Executive Summary</h2>
  <div class="card" style="margin-bottom:16px;border-left:3px solid var(--ac)">
    <p style="font-size:13px;color:var(--tx2);line-height:1.7">
      <strong style="color:var(--tx)">Objective:</strong> Build a production-grade multi-RAG pipeline that intelligently routes user queries to the optimal retrieval strategy (vector search, knowledge graph, SQL analytics, or orchestrated multi-pipeline). The system is validated against <strong style="color:var(--tx)">16 HuggingFace benchmark datasets</strong> across 5 incremental phases (200 &rarr; 1K &rarr; 10K &rarr; 100K &rarr; 1M+ questions), ensuring accuracy, latency, and cost are optimized at every scale. The goal is a pipeline exportable to <em>any</em> data type and database.
    </p>
  </div>

  <!-- Phase Progress -->
  <h3>Phase Roadmap</h3>
  <div class="phase-line" id="exec-phases"></div>

  <!-- Key Metrics -->
  <div class="grid g5" id="exec-stats"></div>

  <!-- Pipeline Gauges -->
  <h3 style="margin-top:16px">Pipeline Performance vs Targets</h3>
  <div class="grid g4" id="exec-gauges"></div>

  <!-- Charts row -->
  <div class="grid g2" style="margin-top:16px">
    <div class="card"><h3>Accuracy Trend</h3><canvas id="ch-exec-trend" height="200"></canvas></div>
    <div class="card"><h3>Error Distribution</h3><canvas id="ch-exec-errors" height="200"></canvas></div>
  </div>

  <!-- Blockers + Next Actions -->
  <div class="grid g2" style="margin-top:12px">
    <div class="card"><h3>Active Blockers</h3><div id="exec-blockers"></div></div>
    <div class="card"><h3>Next Actions</h3><div id="exec-actions"></div></div>
  </div>
</div>

<!-- ============ TAB 2: FOCUS ============ -->
<div class="panel" id="p-focus">
  <h2>Focus: Current Step Detail</h2>

  <!-- Incremental Testing Progress -->
  <div class="card" style="margin-bottom:16px;border-left:3px solid var(--pp)">
    <h3>Incremental Testing Protocol</h3>
    <p style="font-size:12px;color:var(--tx2);margin-bottom:12px">Test endpoints &rarr; 5q parallel per workflow &rarr; fix &rarr; repeat until pass &rarr; scale to 10, 50, 200, 1000...</p>
    <div id="focus-steps"></div>
  </div>

  <!-- Current phase detail -->
  <div class="grid g2">
    <div class="card">
      <h3>Phase 1 — Exit Criteria</h3>
      <div id="focus-gates"></div>
    </div>
    <div class="card">
      <h3>Phase 2 — Readiness</h3>
      <div id="focus-p2"></div>
    </div>
  </div>

  <!-- Per-pipeline iteration detail -->
  <h3 style="margin-top:16px">Latest Iteration Results</h3>
  <div class="grid g4" id="focus-pipes"></div>

  <!-- What's working / What's not -->
  <div class="grid g2" style="margin-top:12px">
    <div class="card" style="border-left:3px solid var(--gn)"><h3>What's Working</h3><div id="focus-pass"></div></div>
    <div class="card" style="border-left:3px solid var(--rd)"><h3>What Needs Fixing</h3><div id="focus-fail"></div></div>
  </div>
</div>

<!-- ============ TAB 3: QUESTIONS ============ -->
<div class="panel" id="p-questions">
  <h2>Questions Explorer</h2>
  <div class="filters">
    <select id="q-phase"><option value="">All Phases</option><option value="1">Phase 1 (200q)</option><option value="2">Phase 2 (1000q)</option></select>
    <select id="q-pipe"><option value="">All Pipelines</option><option value="standard">Standard</option><option value="graph">Graph</option><option value="quantitative">Quantitative</option><option value="orchestrator">Orchestrator</option></select>
    <select id="q-status"><option value="">All Status</option><option value="pass">Pass</option><option value="fail">Fail</option><option value="error">Error</option></select>
    <select id="q-dataset"><option value="">All Datasets</option></select>
    <input type="text" id="q-search" placeholder="Search ID, question text, expected answer...">
  </div>
  <div class="card" style="padding:0;max-height:70vh;overflow:auto">
    <table>
      <thead><tr><th>ID</th><th>Pipeline</th><th>Phase</th><th>Question</th><th>Expected</th><th>Runs</th><th>Pass%</th><th>Best F1</th><th>Status</th><th>Trend</th></tr></thead>
      <tbody id="q-tbody"></tbody>
    </table>
  </div>
  <div id="q-detail" style="margin-top:12px"></div>
</div>

<!-- ============ TAB 4: WORKFLOWS ============ -->
<div class="panel" id="p-workflows">
  <h2>Workflows</h2>
  <p style="color:var(--tx2);margin-bottom:16px">n8n Cloud workflows with node-level detail. Each workflow is linked to its n8n instance for live inspection.</p>

  <!-- Workflow cards -->
  <div class="grid g4" id="wf-cards"></div>

  <!-- Node breakdown per workflow -->
  <h3 style="margin-top:16px">Node Breakdown</h3>
  <div id="wf-nodes"></div>

  <!-- Modification History -->
  <h3 style="margin-top:16px">Modification History (by Step)</h3>
  <div class="card" style="padding:0;max-height:50vh;overflow:auto">
    <table>
      <thead><tr><th>Timestamp</th><th>Type</th><th>Description</th><th>Pipelines</th><th>Impact</th></tr></thead>
      <tbody id="wf-history"></tbody>
    </table>
  </div>

  <!-- DB Snapshots -->
  <h3 style="margin-top:16px">Database State Over Time</h3>
  <div class="card"><canvas id="ch-wf-db" height="180"></canvas></div>
</div>

<!-- ============ TAB 5: DATABASES ============ -->
<div class="panel" id="p-databases">
  <h2>Databases</h2>

  <!-- DB status cards -->
  <div class="grid g3" id="db-cards"></div>

  <!-- Phase Readiness Matrix -->
  <h3 style="margin-top:16px">Phase Readiness Matrix</h3>
  <div class="card" style="padding:0;overflow:auto">
    <table id="db-readiness-table">
      <thead><tr><th>Database</th><th>Phase 1 (200q)</th><th>Phase 2 (1Kq)</th><th>Phase 3 (10Kq)</th><th>Phase 4 (100Kq)</th><th>Phase 5 (1M+)</th></tr></thead>
      <tbody id="db-readiness"></tbody>
    </table>
  </div>

  <!-- Growth chart -->
  <h3 style="margin-top:16px">Data Growth Over Time</h3>
  <div class="card"><canvas id="ch-db-growth" height="200"></canvas></div>

  <!-- Missing data -->
  <h3 style="margin-top:16px">Missing Data for Next Phase</h3>
  <div id="db-missing"></div>
</div>

<!-- ============ TAB 6: COSTS & MODELS ============ -->
<div class="panel" id="p-costs">
  <h2>Costs & Models</h2>

  <!-- Model registry -->
  <h3>LLM Model Registry (per n8n Node)</h3>
  <div class="card" style="padding:0;max-height:50vh;overflow:auto">
    <table>
      <thead><tr><th>Workflow</th><th>Node</th><th>Model</th><th>Provider</th><th>Cost/1K tokens</th><th>Role</th><th>Avg Tokens</th></tr></thead>
      <tbody id="cost-models"></tbody>
    </table>
  </div>

  <!-- Cost summary -->
  <div class="grid g4" style="margin-top:16px" id="cost-stats"></div>

  <!-- Phase cost projection -->
  <h3 style="margin-top:16px">Cost Projection by Phase</h3>
  <div class="card"><canvas id="ch-cost-phase" height="200"></canvas></div>

  <!-- Per-pipeline cost -->
  <h3 style="margin-top:16px">Cost per Question by Pipeline</h3>
  <div class="card"><canvas id="ch-cost-pipe" height="200"></canvas></div>
</div>

<!-- ============ TAB 7: AI AGENT ============ -->
<div class="panel" id="p-agent">
  <h2>AI Agent Reference</h2>
  <p style="color:var(--tx2);margin-bottom:16px">Everything the agentic workflow needs: credentials, commands, iteration protocol, and decision rules. This page is the single source of truth for CLAUDE.md.</p>

  <!-- Environment Variables -->
  <div class="card" style="margin-bottom:16px">
    <h3>Environment Variables <span style="color:var(--tx3);text-transform:none;font-weight:400">(paste in Termius/GCloud Console)</span></h3>
    <div id="agent-env"></div>
  </div>

  <!-- Iteration Protocol -->
  <div class="card" style="margin-bottom:16px;border-left:3px solid var(--ac)">
    <h3>Iteration Protocol</h3>
    <div id="agent-protocol"></div>
  </div>

  <!-- Command Reference -->
  <div class="card" style="margin-bottom:16px">
    <h3>Command Reference</h3>
    <div id="agent-commands"></div>
  </div>

  <!-- Decision Rules -->
  <div class="card" style="margin-bottom:16px">
    <h3>AI Decision Rules</h3>
    <div id="agent-rules"></div>
  </div>

  <!-- API Schema -->
  <div class="card">
    <h3>data.json Schema (v2.0)</h3>
    <details><summary>Expand Schema</summary>
    <div class="detail-content"><pre class="code-block" style="font-size:11px" id="agent-schema"></pre></div>
    </details>
  </div>
</div>

<script>
// ============================================================
// GLOBAL STATE
// ============================================================
let DATA=null,charts={};
const PIPES=['standard','graph','quantitative','orchestrator'];
const PCOL={standard:'#4f8efa',graph:'#2dd47a',quantitative:'#e8b820',orchestrator:'#f08030'};
const PTARGET={standard:85,graph:70,quantitative:85,orchestrator:70};
const P2TARGET={graph:60,quantitative:70};
const ECOL={TIMEOUT:'#f05555',NETWORK:'#f08030',SERVER_ERROR:'#e8b820',EMPTY_RESPONSE:'#a060f0',RATE_LIMIT:'#20c0d8',ENTITY_MISS:'#e060a0',SQL_ERROR:'#4f8efa',UNKNOWN:'#556070',CREDITS_EXHAUSTED:'#f05555'};
const N8N_HOST='https://amoret.app.n8n.cloud';
const WF_IDS={standard:'LnTqRX4LZlI009Ks-3Jnp',graph:'95x2BBAbJlLWZtWEJn6rb',quantitative:'E19NZG9WfM7FNsxr',orchestrator:'ALd4gOEqiKL5KR1p'};

// Model registry (static config — derived from workflow JSON analysis)
const MODEL_REGISTRY=[
  {wf:'Standard',node:'HyDE Generator',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Hypothetical document generation',avg_tokens:400},
  {wf:'Standard',node:'LLM Generation',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Answer synthesis from retrieved context',avg_tokens:500},
  {wf:'Standard',node:'Cohere Rerank',model:'rerank-v3.5',provider:'Cohere',cost_in:0.002,cost_out:0,role:'Re-rank retrieved passages',avg_tokens:2000},
  {wf:'Graph',node:'HyDE Entity Extraction',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Extract entities from query',avg_tokens:350},
  {wf:'Graph',node:'Answer Synthesis',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Generate answer from graph paths',avg_tokens:600},
  {wf:'Quantitative',node:'Text-to-SQL Generator',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Natural language to SQL',avg_tokens:450},
  {wf:'Quantitative',node:'SQL Validator',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Validate and fix SQL',avg_tokens:300},
  {wf:'Quantitative',node:'Interpretation Layer',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Interpret SQL results as answer',avg_tokens:400},
  {wf:'Orchestrator',node:'Intent Analyzer',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Route query to correct pipeline',avg_tokens:300},
  {wf:'Orchestrator',node:'Task Planner',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Plan sub-tasks',avg_tokens:500},
  {wf:'Orchestrator',node:'Response Builder V9',model:'google/gemini-2.0-flash-001',provider:'OpenRouter',cost_in:0.075,cost_out:0.30,role:'Merge sub-pipeline results',avg_tokens:600},
  {wf:'Standard',node:'Pinecone Query',model:'text-embedding-3-small',provider:'OpenAI',cost_in:0.02,cost_out:0,role:'Vector embedding for retrieval',avg_tokens:300},
];

// Phase cost projections
const PHASE_COSTS=[
  {phase:'Phase 1 (200q)',llm:0.03,embed:0,db:0,total:0.03},
  {phase:'Phase 2 (1Kq)',llm:0.15,embed:0.05,db:0,total:0.20},
  {phase:'Phase 3 (10Kq)',llm:1.50,embed:0.50,db:0,total:2.00},
  {phase:'Phase 4 (100Kq)',llm:15,embed:5,db:0,total:20},
  {phase:'Phase 5 (1M+)',llm:150,embed:50,db:50,total:250},
];

// DB readiness data
const DB_READINESS={
  pinecone:[
    {status:'ready',detail:'10,411 vectors, 12 namespaces'},
    {status:'ready',detail:'No changes needed'},
    {status:'partial',detail:'~2-5K additional vectors needed'},
    {status:'upgrade',detail:'Paid plan needed (>100K vectors)'},
    {status:'upgrade',detail:'Standard tier minimum'}
  ],
  neo4j:[
    {status:'ready',detail:'110 nodes, 151 relationships'},
    {status:'ready',detail:'19,788 nodes, 21,625 relationships'},
    {status:'required',detail:'+hotpotqa entities (~1K new)'},
    {status:'upgrade',detail:'Aura Pro needed (~15K entities)'},
    {status:'upgrade',detail:'Production infrastructure'}
  ],
  supabase:[
    {status:'ready',detail:'88 rows, 5 tables'},
    {status:'ready',detail:'538 rows (450 Phase 2 added)'},
    {status:'partial',detail:'WikiTableQuestions tables'},
    {status:'upgrade',detail:'~50K rows needed'},
    {status:'upgrade',detail:'Pro plan needed'}
  ]
};

// ============================================================
// HELPERS
// ============================================================
const esc=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
const pct=(n,d)=>d?Math.round(n/d*1000)/10:0;
const fmtN=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':String(n);

function mkGauge(val,target,color,label){
  const r=42,c=2*Math.PI*r,pctV=Math.min(val/100,1),off=c*(1-pctV);
  const col=val>=target?'var(--gn)':val>=target-10?'var(--yl)':'var(--rd)';
  return `<div class="gauge"><svg width="100" height="100"><circle class="bg" cx="50" cy="50" r="${r}" stroke-dasharray="${c}"/><circle class="fg" cx="50" cy="50" r="${r}" stroke="${col}" stroke-dasharray="${c}" stroke-dashoffset="${off}"/></svg><div class="val" style="color:${col}">${val}%</div><div class="lbl">${esc(label)}</div><div style="text-align:center;font-size:10px;color:var(--tx3)">Target: ${target}%</div></div>`;
}

function mkStat(v,l,d,dc){
  return `<div class="card stat"><div class="v">${v}</div><div class="l">${l}</div>${d?`<div class="d ${dc||''}">${d}</div>`:''}</div>`;
}

function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}
function getCtx(id){return document.getElementById(id)?.getContext('2d');}

function copyText(text,btn){
  navigator.clipboard.writeText(text).then(()=>{
    btn.textContent='Copied!';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},1500);
  });
}

// ============================================================
// DATA LOADING
// ============================================================
async function loadData(){
  try{
    const r=await fetch('data.json?t='+Date.now());
    DATA=await r.json();
    render();
  }catch(e){console.error('Load error:',e);}
}

function render(){
  if(!DATA)return;
  renderHeader();
  renderExec();
  renderFocus();
  renderQuestions();
  renderWorkflows();
  renderDatabases();
  renderCosts();
  renderAgent();
}

// ============================================================
// HEADER
// ============================================================
function renderHeader(){
  const m=DATA.meta||{};
  const dot=document.getElementById('hd-dot');
  dot.className='dot '+(m.status==='running'?'run':m.status==='error'?'err':'ok');
  document.getElementById('hd-phase').textContent=m.phase||'Phase 1';
  document.getElementById('hd-iter').textContent='Iter '+(m.total_iterations||0);
  document.getElementById('hd-qs').textContent=(m.total_unique_questions||0)+' questions';
  document.getElementById('hd-ts').textContent=m.generated_at?new Date(m.generated_at).toLocaleString():'';
}

// ============================================================
// TAB 1: EXECUTIVE SUMMARY
// ============================================================
function renderExec(){
  // Phase roadmap
  const phases=[{n:1,l:'Baseline',q:'200q'},{n:2,l:'Expand',q:'1Kq'},{n:3,l:'Scale',q:'10Kq'},{n:4,l:'Full HF',q:'100Kq'},{n:5,l:'Million+',q:'1M+q'}];
  const curPhase=1;// TODO: derive from data
  document.getElementById('exec-phases').innerHTML=phases.map(p=>
    `<div class="phase-dot ${p.n===curPhase?'current':p.n<curPhase?'done':'locked'}">P${p.n}: ${p.l} (${p.q})</div>`
  ).join('');

  // Key metrics
  const m=DATA.meta||{};
  const iters=DATA.iterations||[];
  const last=iters[iters.length-1];
  const overall=last?last.overall_accuracy_pct:0;
  const errRate=last?pct(Object.values(last.results_summary||{}).reduce((a,p)=>a+(p.errors||0),0),last.total_tested||1):0;
  document.getElementById('exec-stats').innerHTML=[
    mkStat(overall.toFixed(1)+'%','Overall Accuracy',overall>=75?'Gate: MET':'Gap: '+(75-overall).toFixed(1)+'pp',overall>=75?'d-up':'d-dn'),
    mkStat(m.total_unique_questions||0,'Questions Tested','Phase 1: 200 / Phase 2: 1000'),
    mkStat(m.total_iterations||0,'Iterations','5 eval runs + improvements'),
    mkStat(errRate.toFixed(1)+'%','Error Rate',errRate<5?'Target: <5%':'Above target!',errRate<5?'d-up':'d-dn'),
    mkStat(m.total_test_runs||0,'Total Test Runs','Across all iterations'),
  ].join('');

  // Pipeline gauges
  const pipeTrends=DATA.pipelines||{};
  document.getElementById('exec-gauges').innerHTML=PIPES.map(p=>{
    const trend=pipeTrends[p]?.trend||[];
    const lastT=trend[trend.length-1];
    const acc=lastT?lastT.accuracy_pct:0;
    return `<div class="card">${mkGauge(acc,PTARGET[p],PCOL[p],p)}</div>`;
  }).join('');

  // Accuracy trend chart
  renderExecTrend();
  renderExecErrors();

  // Blockers
  const blockers=[];
  PIPES.forEach(p=>{
    const trend=pipeTrends[p]?.trend||[];
    const lastT=trend[trend.length-1];
    if(lastT){
      if(lastT.accuracy_pct<PTARGET[p]) blockers.push({p:'P0',text:`${p}: ${lastT.accuracy_pct}% (target ${PTARGET[p]}%, gap -${(PTARGET[p]-lastT.accuracy_pct).toFixed(1)}pp)`});
      if(lastT.errors>5) blockers.push({p:'P1',text:`${p}: ${lastT.errors} errors in last iteration`});
    }
  });
  blockers.push({p:'P0',text:'OpenRouter credits EXPIRED — need new API key for LLM calls'});
  document.getElementById('exec-blockers').innerHTML=blockers.length?blockers.map(b=>`<div class="blocker"><span class="priority">${b.p}</span>${esc(b.text)}</div>`).join(''):'<p style="color:var(--gn)">No active blockers</p>';

  // Next actions
  document.getElementById('exec-actions').innerHTML=`
    <ol style="padding-left:20px;color:var(--tx2);line-height:2">
      <li><strong>Set env vars</strong> in Termius (N8N_API_KEY, OPENROUTER_API_KEY)</li>
      <li><strong>Deploy fixes</strong>: <code>python3 workflows/improved/apply.py --deploy</code></li>
      <li><strong>Fast iteration</strong>: <code>python3 eval/fast-iter.py --label "Iter 6"</code></li>
      <li><strong>Full Phase 1 eval</strong>: <code>python3 eval/run-eval-parallel.py --reset</code></li>
      <li><strong>Phase 2 eval</strong>: <code>python3 eval/run-eval-parallel.py --dataset phase-2 --reset</code></li>
    </ol>`;
}

function renderExecTrend(){
  destroyChart('execTrend');
  const ctx=getCtx('ch-exec-trend');if(!ctx)return;
  const iters=DATA.iterations||[];
  const labels=iters.map(i=>i.label||`Iter ${i.number}`);
  const datasets=PIPES.map(p=>({
    label:p,borderColor:PCOL[p],backgroundColor:PCOL[p]+'20',data:iters.map(i=>(i.results_summary||{})[p]?.accuracy_pct||null),
    tension:.3,pointRadius:4,spanGaps:true
  }));
  datasets.push({label:'Target (75%)',borderColor:'#556070',borderDash:[5,5],data:iters.map(()=>75),pointRadius:0});
  charts.execTrend=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{labels:{color:'#8896a8',font:{size:11}}}},scales:{y:{beginAtZero:true,max:100,ticks:{color:'#556070'},grid:{color:'#1c2330'}},x:{ticks:{color:'#556070'},grid:{color:'#1c2330'}}}}});
}

function renderExecErrors(){
  destroyChart('execErr');
  const ctx=getCtx('ch-exec-errors');if(!ctx)return;
  const errs={};
  (DATA.iterations||[]).forEach(iter=>{
    (iter.questions||[]).forEach(q=>{
      if(q.error_type){errs[q.error_type]=(errs[q.error_type]||0)+1;}
    });
  });
  const labels=Object.keys(errs);
  const colors=labels.map(l=>ECOL[l]||'#556070');
  charts.execErr=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:Object.values(errs),backgroundColor:colors}]},options:{responsive:true,plugins:{legend:{position:'right',labels:{color:'#8896a8',font:{size:11}}}}}});
}

// ============================================================
// TAB 2: FOCUS
// ============================================================
function renderFocus(){
  // Incremental steps
  const steps=[
    {level:'Endpoints',q:'health check',status:'done'},
    {level:'5q',q:'5 per pipeline',status:'done'},
    {level:'10q',q:'fast-iter',status:'done'},
    {level:'50q',q:'subset eval',status:'done'},
    {level:'200q',q:'full Phase 1',status:'current'},
    {level:'1000q',q:'Phase 2 HF',status:'ready'},
  ];
  document.getElementById('focus-steps').innerHTML=`<div style="display:flex;gap:6px">`+steps.map(s=>{
    const cls=s.status==='done'?'done':s.status==='current'?'current':'locked';
    return `<div class="phase-dot ${cls}" style="font-size:10px">${s.level}<br><span style="font-weight:400;opacity:.7">${s.q}</span></div>`;
  }).join('')+'</div>';

  // Phase 1 gates
  const pipeTrends=DATA.pipelines||{};
  const gates=[
    {name:'Standard >= 85%',check:()=>{const t=pipeTrends.standard?.trend||[];return t.length?(t[t.length-1].accuracy_pct>=85):false;}},
    {name:'Graph >= 70%',check:()=>{const t=pipeTrends.graph?.trend||[];return t.length?(t[t.length-1].accuracy_pct>=70):false;}},
    {name:'Quantitative >= 85%',check:()=>{const t=pipeTrends.quantitative?.trend||[];return t.length?(t[t.length-1].accuracy_pct>=85):false;}},
    {name:'Orchestrator >= 70%',check:()=>{const t=pipeTrends.orchestrator?.trend||[];return t.length?(t[t.length-1].accuracy_pct>=70):false;}},
    {name:'Overall >= 75%',check:()=>{const iters=DATA.iterations||[];const last=iters[iters.length-1];return last?(last.overall_accuracy_pct>=75):false;}},
    {name:'Error rate < 5%',check:()=>false},
    {name:'3 consecutive stable iterations',check:()=>false},
  ];
  document.getElementById('focus-gates').innerHTML=gates.map(g=>{
    const met=g.check();
    return `<div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:${met?'var(--gn)':'var(--rd)'};font-size:14px">${met?'&#10003;':'&#10007;'}</span><span style="font-size:12px">${esc(g.name)}</span></div>`;
  }).join('');

  // Phase 2 readiness
  document.getElementById('focus-p2').innerHTML=`
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--gn);font-size:14px">&#10003;</span><span>Dataset: 1,000 questions (500 graph + 500 quant)</span></div>
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--gn);font-size:14px">&#10003;</span><span>Supabase: 450 Phase 2 rows populated</span></div>
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--gn);font-size:14px">&#10003;</span><span>Neo4j: 4,884 entities + 21,625 relationships</span></div>
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--gn);font-size:14px">&#10003;</span><span>Pinecone: no changes needed (10,411 vectors)</span></div>
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--rd);font-size:14px">&#10007;</span><span>Phase 1 gates NOT met (prerequisite)</span></div>
    <div style="padding:5px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--yl);font-size:14px">&#9888;</span><span>OpenRouter API key expired</span></div>`;

  // Per-pipeline cards
  const iters=DATA.iterations||[];
  const last=iters[iters.length-1];
  document.getElementById('focus-pipes').innerHTML=PIPES.map(p=>{
    const rs=last?.results_summary?.[p]||{};
    const acc=rs.accuracy_pct||0;
    const target=PTARGET[p];
    const col=acc>=target?'var(--gn)':acc>=target-10?'var(--yl)':'var(--rd)';
    return `<div class="card"><h3 style="color:${PCOL[p]}">${p}</h3>
      <div style="font-size:24px;font-weight:800;color:${col};font-family:'JetBrains Mono'">${acc}%</div>
      <div style="font-size:11px;color:var(--tx3)">Target: ${target}% | Gap: ${(target-acc).toFixed(1)}pp</div>
      <div class="pbar" style="margin-top:8px"><div class="fill" style="width:${acc}%;background:${col}"></div><div class="marker" style="left:${target}%"></div></div>
      <div style="margin-top:8px;font-size:11px;color:var(--tx2)">Tested: ${rs.tested||0} | Errors: ${rs.errors||0} | Avg latency: ${rs.avg_latency_ms||0}ms</div>
    </div>`;
  }).join('');

  // What's working / not
  const reg=DATA.question_registry||{};
  const passing=[],failing=[];
  Object.values(reg).forEach(q=>{
    if(q.current_status==='pass'&&q.total_runs>=2) passing.push(q);
    else if(q.current_status==='fail'||q.current_status==='error') failing.push(q);
  });
  passing.sort((a,b)=>b.best_f1-a.best_f1);
  failing.sort((a,b)=>a.pass_rate-b.pass_rate);

  document.getElementById('focus-pass').innerHTML=passing.slice(0,8).map(q=>
    `<div style="padding:4px 0;font-size:12px"><span class="tag t-pass">PASS</span> <span class="mono">${esc(q.id)}</span> — F1: ${q.best_f1.toFixed(3)} (${q.pass_count}/${q.total_runs} runs)</div>`
  ).join('')||'<p style="color:var(--tx3)">No consistent passes yet</p>';

  document.getElementById('focus-fail').innerHTML=failing.slice(0,8).map(q=>{
    const runs=q.runs||[];
    const lastErr=runs.filter(r=>r.error).pop();
    return `<div style="padding:4px 0;font-size:12px"><span class="tag t-fail">${q.current_status?.toUpperCase()}</span> <span class="mono">${esc(q.id)}</span> — ${lastErr?esc(lastErr.error_type||'UNKNOWN'):'low F1'} (${q.pass_count}/${q.total_runs})</div>`;
  }).join('')||'<p style="color:var(--tx3)">No failures recorded</p>';
}

// ============================================================
// TAB 3: QUESTIONS
// ============================================================
function renderQuestions(){
  const reg=DATA.question_registry||{};
  const entries=Object.values(reg);
  const tbody=document.getElementById('q-tbody');

  // Populate dataset filter
  const datasets=new Set();
  entries.forEach(q=>{if(q.category)datasets.add(q.category);});

  // Filter
  const fPhase=document.getElementById('q-phase').value;
  const fPipe=document.getElementById('q-pipe').value;
  const fStatus=document.getElementById('q-status').value;
  const fSearch=(document.getElementById('q-search').value||'').toLowerCase();

  let filtered=entries.filter(q=>{
    if(fPipe&&q.rag_type!==fPipe)return false;
    if(fStatus){
      if(fStatus==='pass'&&q.current_status!=='pass')return false;
      if(fStatus==='fail'&&q.current_status!=='fail')return false;
      if(fStatus==='error'&&!(q.runs||[]).some(r=>r.error))return false;
    }
    if(fPhase){
      const phase=q.id?.startsWith('graph-musique')||q.id?.startsWith('graph-2wiki')||q.id?.startsWith('quantitative-finqa')||q.id?.startsWith('quantitative-tatqa')||q.id?.startsWith('quantitative-convfinqa')?'2':'1';
      if(phase!==fPhase)return false;
    }
    if(fSearch){
      const hay=(q.id+' '+q.question+' '+q.expected+' '+(q.category||'')).toLowerCase();
      if(!hay.includes(fSearch))return false;
    }
    return true;
  });

  filtered.sort((a,b)=>(a.id||'').localeCompare(b.id||''));

  tbody.innerHTML=filtered.slice(0,200).map(q=>{
    const phase=q.id?.startsWith('graph-musique')||q.id?.startsWith('graph-2wiki')||q.id?.startsWith('quantitative-finqa')||q.id?.startsWith('quantitative-tatqa')||q.id?.startsWith('quantitative-convfinqa')?2:1;
    const statusCls=q.current_status==='pass'?'t-pass':q.current_status==='error'?'t-err':'t-fail';
    const trendIcon=q.trend==='improving'?'&#9650;':q.trend==='regressing'?'&#9660;':'&#8212;';
    const trendCls=q.trend==='improving'?'d-up':q.trend==='regressing'?'d-dn':'d-fl';
    return `<tr class="expandable" data-qid="${esc(q.id)}">
      <td class="mono" style="font-size:11px;white-space:nowrap">${esc(q.id)}</td>
      <td><span style="color:${PCOL[q.rag_type]||'#fff'}">${esc(q.rag_type)}</span></td>
      <td><span class="tag ${phase===1?'t-p1':'t-p2'}">P${phase}</span></td>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.question)}</td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" class="mono">${esc(q.expected)}</td>
      <td>${q.total_runs||0}</td>
      <td>${(q.pass_rate*100).toFixed(0)}%</td>
      <td class="mono">${(q.best_f1||0).toFixed(3)}</td>
      <td><span class="tag ${statusCls}">${(q.current_status||'?').toUpperCase()}</span></td>
      <td class="${trendCls}">${trendIcon}</td>
    </tr>`;
  }).join('');

  // Click to expand
  tbody.querySelectorAll('tr.expandable').forEach(tr=>{
    tr.onclick=()=>{
      const qid=tr.dataset.qid;
      const q=reg[qid];
      if(!q)return;
      const detail=document.getElementById('q-detail');
      const runs=(q.runs||[]).reverse();
      detail.innerHTML=`<div class="card card-accent"><h3>${esc(qid)} — ${esc(q.rag_type)}</h3>
        <p style="margin-bottom:8px"><strong>Question:</strong> ${esc(q.question)}</p>
        <p style="margin-bottom:8px"><strong>Expected:</strong> <code>${esc(q.expected)}</code></p>
        <p style="margin-bottom:12px"><strong>Category:</strong> ${esc(q.category)} | <strong>Best F1:</strong> ${(q.best_f1||0).toFixed(3)} | <strong>Pass rate:</strong> ${(q.pass_rate*100).toFixed(0)}%</p>
        <table><thead><tr><th>Iter</th><th>Result</th><th>F1</th><th>Latency</th><th>Method</th><th>Answer</th><th>Error</th></tr></thead><tbody>
        ${runs.map(r=>`<tr>
          <td>${r.iteration_number||'?'}</td>
          <td><span class="tag ${r.correct?'t-pass':'t-fail'}">${r.correct?'PASS':'FAIL'}</span></td>
          <td class="mono">${(r.f1||0).toFixed(3)}</td>
          <td class="mono">${r.latency_ms||0}ms</td>
          <td>${esc(r.match_type||'')}</td>
          <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.answer||'')}</td>
          <td style="color:var(--rd)">${esc(r.error||'')}</td>
        </tr>`).join('')}
        </tbody></table></div>`;
      detail.scrollIntoView({behavior:'smooth'});
    };
  });
}

// ============================================================
// TAB 4: WORKFLOWS
// ============================================================
function renderWorkflows(){
  const wfv=DATA.workflow_versions||{};
  const n8nUrl=N8N_HOST;

  // Workflow cards
  document.getElementById('wf-cards').innerHTML=PIPES.map(p=>{
    const w=wfv[p]||{};
    return `<div class="card"><h3 style="color:${PCOL[p]}">${p}</h3>
      <div style="font-size:20px;font-weight:700">v${w.version||'?'}</div>
      <div style="font-size:11px;color:var(--tx2);margin:4px 0">${esc(w.name||'')}</div>
      <div style="font-size:11px"><span class="mono">${(w.hash||'').slice(0,12)}</span></div>
      <div style="margin-top:8px;font-size:11px">
        <div>Nodes: <strong>${w.total_nodes||'?'}</strong></div>
        <div>Models: <strong>${(w.models_used||[]).join(', ')||'see registry'}</strong></div>
      </div>
      <div style="margin-top:8px"><a href="${n8nUrl}/workflow/${WF_IDS[p]}" target="_blank" style="font-size:11px">Open in n8n &rarr;</a></div>
    </div>`;
  }).join('');

  // Node breakdown (from model registry as proxy — in production would parse workflow JSON)
  const nodesByWf={};
  MODEL_REGISTRY.forEach(m=>{
    const key=m.wf.toLowerCase();
    if(!nodesByWf[key])nodesByWf[key]=[];
    nodesByWf[key].push(m);
  });
  document.getElementById('wf-nodes').innerHTML=PIPES.map(p=>{
    const nodes=nodesByWf[p]||[];
    const w=wfv[p]||{};
    const nodeTypes={trigger:1,code:0,http:0,db:0,ai:0,merge:0,if_:0};
    // Estimate node types from total count
    const total=w.total_nodes||0;
    return `<details><summary style="color:${PCOL[p]}">${p.toUpperCase()} — ${total} nodes</summary>
    <div class="detail-content">
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">
        <span class="node node-trigger">Webhook (trigger)</span>
        ${nodes.map(n=>{
          const cls=n.role.includes('SQL')?'node-db':n.role.includes('embed')?'node-http':'node-ai';
          return `<span class="node ${cls}">${esc(n.node)}</span>`;
        }).join('')}
        <span class="node node-code">OTEL Init</span>
        <span class="node node-merge">Response Formatter</span>
      </div>
      <table style="font-size:11px"><thead><tr><th>Node</th><th>Model</th><th>Role</th><th>Avg Tokens</th></tr></thead>
      <tbody>${nodes.map(n=>`<tr><td>${esc(n.node)}</td><td class="mono">${esc(n.model)}</td><td>${esc(n.role)}</td><td>${n.avg_tokens}</td></tr>`).join('')}</tbody></table>
    </div></details>`;
  }).join('');

  // Modification history
  const changes=DATA.workflow_changes||[];
  document.getElementById('wf-history').innerHTML=changes.slice().reverse().map(c=>{
    const typeCls=c.change_type==='bugfix'?'t-fail':c.change_type==='improvement'?'t-pass':c.change_type==='deploy'?'t-p1':'t-skip';
    const impact=c.after_metrics?PIPES.filter(p=>c.after_metrics[p]?.accuracy!==null&&c.after_metrics[p]?.accuracy!==undefined).map(p=>{
      const before=c.before_metrics?.[p]?.accuracy;
      const after=c.after_metrics?.[p]?.accuracy;
      if(before!=null&&after!=null){const d=after-before;return `${p}: ${d>0?'+':''}${d.toFixed(1)}pp`;}
      return `${p}: ${after}%`;
    }).join(', '):'—';
    return `<tr><td class="mono" style="font-size:11px;white-space:nowrap">${c.timestamp?.slice(0,16)||'?'}</td>
      <td><span class="tag ${typeCls}">${esc(c.change_type||'')}</span></td>
      <td>${esc(c.description||'')}</td>
      <td>${(c.affected_pipelines||[]).map(p=>`<span style="color:${PCOL[p]}">${p}</span>`).join(', ')}</td>
      <td style="font-size:11px">${impact}</td></tr>`;
  }).join('');

  // DB state chart
  renderDbChart();
}

function renderDbChart(){
  destroyChart('wfDb');
  const ctx=getCtx('ch-wf-db');if(!ctx)return;
  const snaps=DATA.db_snapshots||[];
  if(!snaps.length)return;
  const labels=snaps.map(s=>s.timestamp?.slice(5,16)||'?');
  charts.wfDb=new Chart(ctx,{type:'line',data:{labels,datasets:[
    {label:'Pinecone Vectors',data:snaps.map(s=>s.pinecone_vectors),borderColor:'#4f8efa',tension:.3,pointRadius:2},
    {label:'Neo4j Nodes',data:snaps.map(s=>s.neo4j_nodes),borderColor:'#2dd47a',tension:.3,pointRadius:2},
    {label:'Supabase Rows',data:snaps.map(s=>s.supabase_rows),borderColor:'#e8b820',tension:.3,pointRadius:2},
  ]},options:{responsive:true,plugins:{legend:{labels:{color:'#8896a8',font:{size:11}}}},scales:{y:{ticks:{color:'#556070'},grid:{color:'#1c2330'}},x:{ticks:{color:'#556070',maxRotation:45},grid:{color:'#1c2330'}}}}});
}

// ============================================================
// TAB 5: DATABASES
// ============================================================
function renderDatabases(){
  const db=DATA.databases||{};

  // DB cards
  document.getElementById('db-cards').innerHTML=[
    {name:'Pinecone',icon:'&#9670;',color:'#4f8efa',metric:fmtN(db.pinecone?.total_vectors||10411),label:'vectors',detail:`${Object.keys(db.pinecone?.namespaces||{}).length} namespaces | text-embedding-3-small (1536d)`},
    {name:'Neo4j',icon:'&#9679;',color:'#2dd47a',metric:fmtN(db.neo4j?.total_nodes||19788),label:'nodes',detail:`${fmtN(db.neo4j?.total_relationships||21625)} relationships | ${Object.keys(db.neo4j?.labels||{}).length} entity types`},
    {name:'Supabase',icon:'&#9632;',color:'#e8b820',metric:db.supabase?.total_rows||538,label:'rows',detail:`${Object.keys(db.supabase?.tables||{}).length} tables | 3 companies + Phase 2 HF tables`},
  ].map(d=>`<div class="card"><h3 style="color:${d.color}"><span style="font-size:16px">${d.icon}</span> ${d.name}</h3>
    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono'">${d.metric}</div>
    <div style="font-size:11px;color:var(--tx3)">${d.label}</div>
    <div style="font-size:11px;color:var(--tx2);margin-top:8px">${d.detail}</div>
  </div>`).join('');

  // Phase readiness matrix
  const statusIcon={ready:'<span style="color:var(--gn)">&#10003; Ready</span>',partial:'<span style="color:var(--yl)">&#9888; Partial</span>',required:'<span style="color:var(--rd)">&#10007; Required</span>',upgrade:'<span style="color:var(--pp)">&#8593; Upgrade</span>'};
  document.getElementById('db-readiness').innerHTML=['pinecone','neo4j','supabase'].map(dbName=>{
    return `<tr><td style="font-weight:700;text-transform:capitalize">${dbName}</td>
      ${DB_READINESS[dbName].map(p=>`<td>${statusIcon[p.status]}<br><span style="font-size:10px;color:var(--tx3)">${p.detail}</span></td>`).join('')}
    </tr>`;
  }).join('');

  // Growth chart
  destroyChart('dbGrowth');
  const ctx=getCtx('ch-db-growth');if(!ctx)return;
  const projLabels=['Phase 1','Phase 2','Phase 3','Phase 4','Phase 5'];
  const projData={
    pinecone:[10411,10411,15000,100000,500000],
    neo4j:[110,19788,24000,100000,500000],
    supabase:[88,538,12000,50000,200000]
  };
  charts.dbGrowth=new Chart(ctx,{type:'bar',data:{labels:projLabels,datasets:[
    {label:'Pinecone Vectors',data:projData.pinecone,backgroundColor:'#4f8efa60',borderColor:'#4f8efa',borderWidth:1},
    {label:'Neo4j Nodes',data:projData.neo4j,backgroundColor:'#2dd47a60',borderColor:'#2dd47a',borderWidth:1},
    {label:'Supabase Rows',data:projData.supabase,backgroundColor:'#e8b82060',borderColor:'#e8b820',borderWidth:1},
  ]},options:{responsive:true,plugins:{legend:{labels:{color:'#8896a8',font:{size:11}}}},scales:{y:{type:'logarithmic',ticks:{color:'#556070'},grid:{color:'#1c2330'}},x:{ticks:{color:'#556070'},grid:{color:'#1c2330'}}}}});

  // Missing data
  document.getElementById('db-missing').innerHTML=`
    <div class="card" style="border-left:3px solid var(--yl)">
      <h3>For Phase 3 (10K questions)</h3>
      <ul style="padding-left:20px;color:var(--tx2);line-height:1.8;font-size:12px">
        <li><strong>Pinecone:</strong> ~2,000-5,000 additional vectors for FRAMES dataset gaps</li>
        <li><strong>Neo4j:</strong> ~1,000 new entities from HotpotQA dataset</li>
        <li><strong>Supabase:</strong> WikiTableQuestions additional table structures</li>
        <li><strong>Orchestrator:</strong> ~1,000 mixed-type routing questions</li>
      </ul>
    </div>`;
}

// ============================================================
// TAB 6: COSTS & MODELS
// ============================================================
function renderCosts(){
  // Model registry table
  document.getElementById('cost-models').innerHTML=MODEL_REGISTRY.map(m=>
    `<tr><td style="color:${PCOL[m.wf.toLowerCase()]||'var(--tx)'}">${esc(m.wf)}</td>
      <td>${esc(m.node)}</td><td class="mono">${esc(m.model)}</td>
      <td>${esc(m.provider)}</td>
      <td class="mono">$${m.cost_in}/${m.cost_out?'$'+m.cost_out:'—'}</td>
      <td style="font-size:11px">${esc(m.role)}</td>
      <td class="mono">${m.avg_tokens}</td></tr>`
  ).join('');

  // Cost stats
  const totalCostP1=PHASE_COSTS[0].total;
  const totalCostAll=PHASE_COSTS.reduce((a,p)=>a+p.total,0);
  const avgCostPerQ=totalCostP1/200;
  document.getElementById('cost-stats').innerHTML=[
    mkStat('$'+totalCostP1.toFixed(2),'Phase 1 Cost','200 questions'),
    mkStat('$'+PHASE_COSTS[1].total.toFixed(2),'Phase 2 Projected','1,000 questions'),
    mkStat('$'+avgCostPerQ.toFixed(4),'Cost per Question','Phase 1 average'),
    mkStat('$'+totalCostAll.toFixed(0),'Total All Phases','Projected through Phase 5'),
  ].join('');

  // Phase cost chart
  destroyChart('costPhase');
  const ctx1=getCtx('ch-cost-phase');
  if(ctx1){
    charts.costPhase=new Chart(ctx1,{type:'bar',data:{
      labels:PHASE_COSTS.map(p=>p.phase),
      datasets:[
        {label:'LLM Calls',data:PHASE_COSTS.map(p=>p.llm),backgroundColor:'#f0555580'},
        {label:'Embeddings',data:PHASE_COSTS.map(p=>p.embed),backgroundColor:'#4f8efa80'},
        {label:'Infrastructure',data:PHASE_COSTS.map(p=>p.db),backgroundColor:'#e8b82080'},
      ]
    },options:{responsive:true,plugins:{legend:{labels:{color:'#8896a8',font:{size:11}}}},scales:{y:{stacked:true,type:'logarithmic',ticks:{color:'#556070'},grid:{color:'#1c2330'}},x:{stacked:true,ticks:{color:'#556070'},grid:{color:'#1c2330'}}}}});
  }

  // Per-pipeline cost chart
  destroyChart('costPipe');
  const ctx2=getCtx('ch-cost-pipe');
  if(ctx2){
    const pipeCosts=PIPES.map(p=>{
      const nodes=MODEL_REGISTRY.filter(m=>m.wf.toLowerCase()===p);
      return nodes.reduce((sum,n)=>{
        const inputCost=n.avg_tokens*n.cost_in/1e6;
        const outputCost=n.avg_tokens*n.cost_out/1e6;
        return sum+inputCost+outputCost;
      },0);
    });
    charts.costPipe=new Chart(ctx2,{type:'bar',data:{
      labels:PIPES.map(p=>p.charAt(0).toUpperCase()+p.slice(1)),
      datasets:[{label:'Est. Cost per Question ($)',data:pipeCosts,backgroundColor:PIPES.map(p=>PCOL[p]+'80'),borderColor:PIPES.map(p=>PCOL[p]),borderWidth:1}]
    },options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{color:'#556070',callback:v=>'$'+v.toFixed(5)},grid:{color:'#1c2330'}},x:{ticks:{color:'#556070'},grid:{color:'#1c2330'}}}}});
  }
}

// ============================================================
// TAB 7: AI AGENT
// ============================================================
function renderAgent(){
  // Environment variables
  const envVars=[
    {key:'SUPABASE_PASSWORD',val:'udVECdcSnkMCAPiY',status:'ok'},
    {key:'PINECONE_API_KEY',val:'pcsk_6GzVdD_BbHsYNvpcngMqAHH5EvEa9XLnmFpEK9cx5q5xkMp72z5KFQ1q7dEjp8npWhJGBY',status:'ok'},
    {key:'PINECONE_HOST',val:'https://sota-rag-a4mkzmz.svc.aped-4627-b74a.pinecone.io',status:'ok'},
    {key:'NEO4J_PASSWORD',val:'jV_zGdxbu-emQZM-ZSQux19pTZ5QLKejR2IHSzsbVak',status:'ok'},
    {key:'OPENROUTER_API_KEY',val:'sk-or-v1-... (EXPIRED)',status:'err'},
    {key:'N8N_API_KEY',val:'...',status:'warn'},
    {key:'N8N_HOST',val:'https://amoret.app.n8n.cloud',status:'ok'},
  ];

  const allEnv=envVars.map(e=>`export ${e.key}="${e.val}"`).join('\n');
  document.getElementById('agent-env').innerHTML=`
    <div class="code-block" style="position:relative">${envVars.map(e=>{
      const col=e.status==='ok'?'var(--gn)':e.status==='err'?'var(--rd)':'var(--yl)';
      return `<span style="color:${col}">export</span> ${e.key}=<span style="color:var(--ac)">"${esc(e.val)}"</span>`;
    }).join('\n')}<button class="copy-btn" onclick="copyText(\`${esc(allEnv)}\`,this)">Copy</button></div>`;

  // Iteration Protocol
  document.getElementById('agent-protocol').innerHTML=`
    <div style="font-size:12px;color:var(--tx2);line-height:1.8">
    <p style="font-weight:700;color:var(--tx);margin-bottom:8px">Incremental Testing Principle:</p>
    <p>Test endpoints &rarr; 5q per workflow (parallel) &rarr; analyze &rarr; fix if needed &rarr; repeat until 5q pass &rarr; scale to 10q &rarr; 50q &rarr; 200q &rarr; 1000q. Never skip levels. ONE change per iteration.</p>
    <div style="margin-top:12px;padding:12px;background:var(--s3);border-radius:6px">
      <p style="font-weight:600;color:var(--tx)">Phase A: Fast Iteration (10q/pipeline)</p>
      <ol style="padding-left:20px;line-height:2">
        <li><code>cd ~/mon-ipad && git pull origin main</code></li>
        <li><code>python3 workflows/sync.py</code></li>
        <li><code>python3 eval/quick-test.py --questions 5</code></li>
        <li><code>python3 eval/fast-iter.py --label "description"</code></li>
        <li>Review logs/fast-iter/ and logs/pipeline-results/</li>
        <li>If bad &rarr; fix in n8n &rarr; repeat. If good &rarr; Phase B</li>
      </ol>
    </div>
    <div style="margin-top:8px;padding:12px;background:var(--s3);border-radius:6px">
      <p style="font-weight:600;color:var(--tx)">Phase B: Full Evaluation</p>
      <ol style="padding-left:20px;line-height:2">
        <li><code>python3 eval/run-eval-parallel.py --reset --label "Iter N"</code></li>
        <li><code>python3 eval/run-eval-parallel.py --dataset phase-2 --reset --label "Phase 2"</code></li>
        <li><code>python3 eval/analyzer.py</code></li>
        <li><code>git add docs/ workflows/ logs/ && git commit && git push origin main</code></li>
      </ol>
    </div>
    </div>`;

  // Command reference
  const commands=[
    {cmd:'python3 eval/fast-iter.py',desc:'Fast iteration (10q/pipeline, parallel)',flags:'--questions 5 --pipelines graph --dataset phase-2 --only-failing --label "desc"'},
    {cmd:'python3 eval/run-eval-parallel.py',desc:'Full parallel eval (all pipelines concurrent)',flags:'--reset --max 20 --types graph,quantitative --dataset phase-2 --push --label "desc"'},
    {cmd:'python3 eval/run-eval.py',desc:'Sequential eval (legacy/debug)',flags:'--dataset phase-2 --reset --max 10 --types graph'},
    {cmd:'python3 eval/quick-test.py',desc:'Smoke test (3-5 known-good questions)',flags:'--questions 5'},
    {cmd:'python3 eval/analyzer.py',desc:'Post-eval analysis + recommendations',flags:''},
    {cmd:'python3 workflows/sync.py',desc:'Pull workflow JSON from n8n cloud',flags:''},
    {cmd:'python3 workflows/improved/apply.py',desc:'Apply + deploy workflow patches',flags:'--local --deploy'},
    {cmd:'python3 db/populate/phase2_supabase.py',desc:'Populate Phase 2 Supabase tables',flags:'--reset --dry-run --dataset finqa'},
    {cmd:'python3 db/populate/phase2_neo4j.py',desc:'Extract Phase 2 Neo4j entities',flags:'--reset --llm --limit 50'},
  ];
  document.getElementById('agent-commands').innerHTML=`<table><thead><tr><th>Command</th><th>Description</th><th>Flags</th></tr></thead><tbody>
    ${commands.map(c=>`<tr><td class="mono" style="white-space:nowrap">${esc(c.cmd)}</td><td>${esc(c.desc)}</td><td class="mono" style="font-size:10px;color:var(--tx3)">${esc(c.flags)}</td></tr>`).join('')}
  </tbody></table>`;

  // Decision rules
  document.getElementById('agent-rules').innerHTML=`
    <ol style="padding-left:20px;color:var(--tx2);line-height:2;font-size:12px">
      <li>If <strong>accuracy &lt; target</strong> for a pipeline: analyze error traces, then fix ONE root cause and re-test</li>
      <li>If <strong>error rate &gt; 10%</strong>: prioritize error fixes over accuracy improvements</li>
      <li>If <strong>3+ regressions</strong> detected: REVERT the last change immediately</li>
      <li>If <strong>orchestrator timeout &gt; 60s</strong>: reduce sub-pipeline invocations (single-pipeline routing)</li>
      <li>If <strong>graph entity extraction fails</strong>: check entity catalog in HyDE prompt, add fuzzy matching</li>
      <li>If <strong>SQL errors &gt; 5</strong>: review Schema Context hints, add ILIKE and period rules</li>
      <li>If <strong>empty responses &gt; 10</strong>: check continueOnFail settings, add null-safe guards</li>
      <li><strong>NEVER</strong> change multiple things per iteration — ONE fix, then test</li>
      <li><strong>NEVER</strong> run eval in Claude Code sandbox — only in Termius / GCloud Console</li>
      <li>After Phase 1 gates pass, run Phase 2: <code>--dataset phase-2 --reset</code></li>
    </ol>`;

  // API Schema
  document.getElementById('agent-schema').textContent=JSON.stringify({
    meta:{version:'2.0',status:'running|complete|error',phase:'string',total_unique_questions:'number',total_test_runs:'number',total_iterations:'number'},
    iterations:[{id:'string',number:'number',label:'string',questions:[{id:'string',rag_type:'string',correct:'boolean',f1:'number',error:'string|null'}],results_summary:{pipeline:{tested:'number',correct:'number',errors:'number',accuracy_pct:'number',avg_latency_ms:'number'}}}],
    question_registry:{qid:{question:'string',expected:'string',rag_type:'string',current_status:'pass|fail|error',trend:'improving|regressing|stable',runs:[]}},
    pipelines:{name:{endpoint:'string',target_accuracy:'number',trend:[]}},
    workflow_versions:{pipeline:{version:'number',hash:'string',total_nodes:'number'}},
    databases:{pinecone:{total_vectors:'number'},neo4j:{total_nodes:'number'},supabase:{total_rows:'number'}},
  },null,2);
}

// ============================================================
// TAB SWITCHING
// ============================================================
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('p-'+tab.dataset.tab).classList.add('active');
  });
});

// Question filters
['q-phase','q-pipe','q-status','q-dataset'].forEach(id=>{
  document.getElementById(id)?.addEventListener('change',renderQuestions);
});
document.getElementById('q-search')?.addEventListener('input',renderQuestions);

// ============================================================
// INIT
// ============================================================
loadData();
setInterval(loadData,15000);
</script>
</body>
</html>
