<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAG Test Runner — SOTA 2026</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
:root{--bg:#0b0f15;--s1:#111720;--s2:#171d28;--s3:#1e2533;--bd:#2a3140;--tx:#dce4f0;--tx2:#7f8da0;--tx3:#4e5a6d;--ac:#4f8efa;--gn:#2dd47a;--gn-bg:rgba(45,212,122,.1);--rd:#f05555;--rd-bg:rgba(240,85,85,.1);--yl:#e8b820;--yl-bg:rgba(232,184,32,.1);--or:#f08030;--pp:#a060f0;--cy:#20c0d8}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:'Inter',system-ui,sans-serif;font-size:13px;line-height:1.5}
::selection{background:var(--ac);color:#fff}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
code,.mono{font-family:'JetBrains Mono',monospace;font-size:.92em}
a{color:var(--ac);text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:var(--s1);border-bottom:1px solid var(--bd);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header h1{font-size:15px;font-weight:600;letter-spacing:-.02em;display:flex;align-items:center;gap:8px}
.header .meta{display:flex;gap:16px;align-items:center;font-size:12px;color:var(--tx2)}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.status-dot.ok{background:var(--gn);box-shadow:0 0 6px var(--gn)}
.status-dot.running{background:var(--yl);animation:blink 1.5s infinite}
.status-dot.error{background:var(--rd)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* Tabs */
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bd);padding:0 24px;overflow-x:auto;gap:0}
.tab{padding:10px 20px;font-size:12.5px;font-weight:500;color:var(--tx2);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.tab:hover{color:var(--tx)}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.panel{display:none;padding:20px 24px;max-width:1600px;margin:0 auto}
.panel.active{display:block}

/* Cards */
.card{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:16px;overflow:hidden}
.card h3{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);margin-bottom:10px}
.grid{display:grid;gap:12px;margin:12px 0}
.g4{grid-template-columns:repeat(4,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g2{grid-template-columns:1fr 1fr}
.g1-2{grid-template-columns:1fr 2fr}
.g2-1{grid-template-columns:2fr 1fr}

/* Stat cards */
.stat{text-align:center}
.stat .value{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace}
.stat .label{font-size:11px;color:var(--tx2);margin-top:2px}
.stat .delta{font-size:11px;font-weight:600;margin-top:2px}
.delta-up{color:var(--gn)}
.delta-down{color:var(--rd)}
.delta-flat{color:var(--tx3)}

/* Tags */
.tag{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10.5px;font-weight:600;letter-spacing:.02em}
.tag-pass{background:var(--gn-bg);color:var(--gn)}
.tag-fail{background:var(--rd-bg);color:var(--rd)}
.tag-error{background:var(--yl-bg);color:var(--yl)}
.tag-skip{background:rgba(78,90,109,.15);color:var(--tx3)}
.tag-improving{background:rgba(45,212,122,.12);color:var(--gn)}
.tag-regressing{background:rgba(240,85,85,.12);color:var(--rd)}
.tag-stable{background:rgba(78,90,109,.12);color:var(--tx3)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:12.5px}
th{text-align:left;padding:8px 10px;background:var(--s3);color:var(--tx2);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.04em;position:sticky;top:0;z-index:2}
td{padding:7px 10px;border-top:1px solid var(--bd)}
tr:hover td{background:rgba(255,255,255,.02)}

/* Test matrix cells */
.cell-pass{background:rgba(45,212,122,.18);color:var(--gn);text-align:center;font-weight:600;font-size:11px;cursor:pointer;min-width:28px}
.cell-fail{background:rgba(240,85,85,.18);color:var(--rd);text-align:center;font-weight:600;font-size:11px;cursor:pointer}
.cell-error{background:rgba(232,184,32,.18);color:var(--yl);text-align:center;font-weight:600;font-size:11px;cursor:pointer}
.cell-skip{background:transparent;color:var(--tx3);text-align:center;font-size:10px}
.cell-pass:hover,.cell-fail:hover,.cell-error:hover{outline:2px solid var(--ac);outline-offset:-1px;z-index:1;position:relative}

/* Accuracy bar */
.acc-bar{height:6px;background:var(--s3);border-radius:3px;overflow:hidden;position:relative}
.acc-bar .fill{height:100%;border-radius:3px;transition:width .3s}
.acc-bar .target{position:absolute;top:-2px;height:10px;width:2px;background:var(--tx2)}

/* Search */
.search-box{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.search-box input{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:7px 12px;color:var(--tx);font-size:12.5px;flex:1;outline:none}
.search-box input:focus{border-color:var(--ac)}
.search-box select{background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:7px 10px;color:var(--tx);font-size:12.5px;outline:none}

/* Timeline */
.timeline{position:relative;padding-left:24px}
.timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--bd)}
.timeline-item{position:relative;margin-bottom:20px;padding:14px;background:var(--s2);border:1px solid var(--bd);border-radius:8px}
.timeline-item::before{content:'';position:absolute;left:-21px;top:18px;width:10px;height:10px;border-radius:50%;background:var(--ac);border:2px solid var(--bg)}
.timeline-item .time{font-size:11px;color:var(--tx3);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.timeline-item h4{font-size:14px;font-weight:600;margin-bottom:6px}
.timeline-item .changes{font-size:12px;color:var(--tx2);margin-bottom:8px}
.timeline-item .metrics{display:flex;gap:16px;flex-wrap:wrap}
.timeline-item .metric{font-size:12px}
.timeline-item .metric strong{color:var(--tx)}

/* Expandable */
.expandable{cursor:pointer}
.expandable::after{content:'';display:inline-block;width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid var(--tx3);margin-left:6px;transition:transform .2s}
.expandable.open::after{transform:rotate(180deg)}
.expand-content{display:none;padding-top:10px}
.expand-content.open{display:block}

/* Detail panel */
.detail-panel{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:16px;margin-top:8px}
.detail-panel .answer-block{background:var(--s3);border-radius:6px;padding:10px 12px;margin:6px 0;font-size:12.5px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto}
.detail-panel .answer-block.expected{border-left:3px solid var(--gn)}
.detail-panel .answer-block.actual{border-left:3px solid var(--ac)}
.detail-panel .answer-block.error-block{border-left:3px solid var(--rd)}

/* Diff highlight */
.diff-added{background:rgba(45,212,122,.15);color:var(--gn)}
.diff-removed{background:rgba(240,85,85,.15);color:var(--rd)}

/* Responsive */
@media(max-width:1200px){.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.g4,.g3,.g2{grid-template-columns:1fr}.panel{padding:12px}}

/* Tooltip */
.tooltip{position:relative}
.tooltip .tip{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--s1);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;font-size:11.5px;white-space:nowrap;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.tooltip:hover .tip{display:block}

/* Pipeline colors */
.pipe-standard{color:#4f8efa}
.pipe-graph{color:#a060f0}
.pipe-quantitative{color:#20c0d8}
.pipe-orchestrator{color:#f08030}
.dot-standard{background:#4f8efa}
.dot-graph{background:#a060f0}
.dot-quantitative{background:#20c0d8}
.dot-orchestrator{background:#f08030}

/* Print */
@media print{.header,.tabs{display:none}.panel{display:block!important}}
</style>
</head>
<body>

<div class="header">
  <h1>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
    RAG Test Runner
    <span id="statusDot" class="status-dot ok"></span>
  </h1>
  <div class="meta">
    <span id="metaPhase">Phase 1</span>
    <span id="metaIterations">0 iterations</span>
    <span id="metaQuestions">0 questions</span>
    <span id="metaRuns">0 test runs</span>
    <span id="metaUpdated" class="mono">--</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="matrix">Test Matrix</div>
  <div class="tab" data-tab="iterations">Iterations</div>
  <div class="tab" data-tab="questions">Questions</div>
  <div class="tab" data-tab="pipelines">Pipelines</div>
  <div class="tab" data-tab="changes">Changes Log</div>
  <div class="tab" data-tab="api">Agentic API</div>
</div>

<!-- TAB 1: TEST MATRIX -->
<div id="tab-matrix" class="panel active">
  <div class="grid g4" id="summaryCards"></div>

  <div class="card" style="margin-top:12px">
    <h3>Test Matrix: Questions x Iterations <span id="matrixFilterInfo" style="font-weight:400;text-transform:none;color:var(--tx3)"></span></h3>
    <div class="search-box">
      <select id="matrixPipeFilter">
        <option value="all">All pipelines</option>
        <option value="standard">Standard</option>
        <option value="graph">Graph</option>
        <option value="quantitative">Quantitative</option>
        <option value="orchestrator">Orchestrator</option>
      </select>
      <select id="matrixStatusFilter">
        <option value="all">All statuses</option>
        <option value="pass">Passing</option>
        <option value="fail">Failing</option>
        <option value="error">Errors</option>
        <option value="regressing">Regressing</option>
        <option value="improving">Improving</option>
      </select>
      <input type="text" id="matrixSearch" placeholder="Search question ID or text...">
    </div>
    <div style="overflow-x:auto;max-height:70vh;overflow-y:auto">
      <table id="matrixTable">
        <thead id="matrixHeader"></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>
  </div>

  <div id="questionDetail" class="detail-panel" style="display:none;margin-top:12px"></div>
</div>

<!-- TAB 2: ITERATIONS -->
<div id="tab-iterations" class="panel">
  <div class="card" style="margin-bottom:12px">
    <h3>Accuracy Trend Across Iterations</h3>
    <canvas id="iterChart" height="250"></canvas>
  </div>
  <div class="card">
    <h3>Iteration Comparison</h3>
    <div class="search-box">
      <select id="iterCompareA"></select>
      <span style="color:var(--tx3)">vs</span>
      <select id="iterCompareB"></select>
      <button onclick="compareIterations()" style="background:var(--ac);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:12px">Compare</button>
    </div>
    <div id="iterCompareResult"></div>
  </div>
  <div style="margin-top:16px">
    <h3 style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);margin-bottom:12px">Iteration Timeline</h3>
    <div class="timeline" id="iterTimeline"></div>
  </div>
</div>

<!-- TAB 3: QUESTIONS -->
<div id="tab-questions" class="panel">
  <div class="search-box">
    <input type="text" id="qSearch" placeholder="Search by ID, question text, or expected answer...">
    <select id="qPipeFilter">
      <option value="all">All pipelines</option>
      <option value="standard">Standard</option>
      <option value="graph">Graph</option>
      <option value="quantitative">Quantitative</option>
      <option value="orchestrator">Orchestrator</option>
    </select>
    <select id="qStatusFilter">
      <option value="all">All</option>
      <option value="pass">Passing</option>
      <option value="fail">Failing</option>
      <option value="error">Has errors</option>
      <option value="improving">Improving</option>
      <option value="regressing">Regressing</option>
    </select>
  </div>
  <div style="overflow-x:auto">
    <table>
      <thead>
        <tr>
          <th style="width:80px">ID</th>
          <th>Question</th>
          <th style="width:80px">Pipeline</th>
          <th style="width:60px">Runs</th>
          <th style="width:70px">Pass Rate</th>
          <th style="width:60px">Best F1</th>
          <th style="width:80px">Status</th>
          <th style="width:70px">Trend</th>
        </tr>
      </thead>
      <tbody id="questionsBody"></tbody>
    </table>
  </div>
  <div id="qDetailPanel" class="detail-panel" style="display:none;margin-top:12px"></div>
</div>

<!-- TAB 4: PIPELINES -->
<div id="tab-pipelines" class="panel">
  <div class="grid g4" id="pipelineCards"></div>
  <div class="grid g2" style="margin-top:12px">
    <div class="card">
      <h3>Accuracy per Iteration</h3>
      <canvas id="pipeAccChart" height="280"></canvas>
    </div>
    <div class="card">
      <h3>Error Rate per Iteration</h3>
      <canvas id="pipeErrChart" height="280"></canvas>
    </div>
  </div>
  <div class="grid g2" style="margin-top:12px">
    <div class="card">
      <h3>Average Latency (ms)</h3>
      <canvas id="pipeLatChart" height="280"></canvas>
    </div>
    <div class="card">
      <h3>Question Category Breakdown</h3>
      <div id="categoryBreakdown"></div>
    </div>
  </div>
</div>

<!-- TAB 5: CHANGES LOG -->
<div id="tab-changes" class="panel">
  <div class="card">
    <h3>Workflow Changes & Impact</h3>
    <table>
      <thead>
        <tr>
          <th style="width:150px">Timestamp</th>
          <th style="width:100px">Type</th>
          <th>Description</th>
          <th style="width:120px">Pipelines</th>
          <th style="width:100px">Impact</th>
        </tr>
      </thead>
      <tbody id="changesBody"></tbody>
    </table>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Database State Over Time</h3>
    <table>
      <thead>
        <tr>
          <th>Snapshot</th>
          <th>Trigger</th>
          <th>Pinecone Vectors</th>
          <th>Neo4j Nodes</th>
          <th>Neo4j Rels</th>
          <th>Supabase Rows</th>
        </tr>
      </thead>
      <tbody id="dbSnapshotsBody"></tbody>
    </table>
  </div>
</div>

<!-- TAB 6: AGENTIC API -->
<div id="tab-api" class="panel">
  <div class="card">
    <h3>Agentic Evaluation API</h3>
    <p style="color:var(--tx2);margin-bottom:12px">This data structure is designed for consumption by an AI agent that continuously evaluates and improves the RAG pipelines. The agent reads <code>data.json</code> and uses the structured data to make improvement decisions.</p>

    <h4 style="font-size:13px;margin:16px 0 8px">Data Schema (v2.0)</h4>
    <div class="answer-block" style="background:var(--s3);border-radius:6px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:pre;overflow-x:auto;max-height:400px;overflow-y:auto" id="apiSchema"></div>

    <h4 style="font-size:13px;margin:16px 0 8px">Decision Rules for Agentic Evaluation</h4>
    <div id="agenticRules" style="font-size:12.5px;color:var(--tx2)"></div>

    <h4 style="font-size:13px;margin:16px 0 8px">GitHub Actions Integration</h4>
    <div id="ghActionsDoc"></div>

    <h4 style="font-size:13px;margin:16px 0 8px">Quick Test Endpoint</h4>
    <div class="answer-block" style="background:var(--s3);border-radius:6px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:pre;overflow-x:auto">POST https://amoret.app.n8n.cloud/webhook/{endpoint}
Content-Type: application/json

{
  "query": "test question",
  "tenant_id": "benchmark",
  "top_k": 10,
  "include_sources": true,
  "benchmark_mode": true
}</div>

    <h4 style="font-size:13px;margin:16px 0 8px">Running Evaluations</h4>
    <div class="answer-block" style="background:var(--s3);border-radius:6px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:pre;overflow-x:auto"># Full eval (all pipelines, skip already-tested)
python run-comprehensive-eval.py

# Specific pipelines, max 10 per type
python run-comprehensive-eval.py --types standard,graph --max 10

# Re-test everything (ignore dedup)
python run-comprehensive-eval.py --reset

# GitHub Actions: trigger manually
gh workflow run rag-eval.yml -f types=standard,graph -f max_per_type=10 -f reset=true</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// ============================================================
// State
// ============================================================
let DATA = null;
let selectedQuestion = null;
let charts = {};

// ============================================================
// Data loading
// ============================================================
async function loadData() {
  try {
    const resp = await fetch('data.json?' + Date.now());
    DATA = await resp.json();
    render();
  } catch (e) {
    console.error('Failed to load data.json:', e);
  }
}

// ============================================================
// Tab switching
// ============================================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ============================================================
// Main render
// ============================================================
function render() {
  if (!DATA) return;
  renderHeader();
  renderSummaryCards();
  renderMatrix();
  renderIterations();
  renderQuestions();
  renderPipelines();
  renderChanges();
  renderAPI();
}

// ============================================================
// Header
// ============================================================
function renderHeader() {
  const m = DATA.meta;
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot ' + (m.status === 'running' ? 'running' : 'ok');
  document.getElementById('metaPhase').textContent = m.phase || 'Phase 1';
  document.getElementById('metaIterations').textContent = m.total_iterations + ' iterations';
  document.getElementById('metaQuestions').textContent = m.total_unique_questions + ' questions';
  document.getElementById('metaRuns').textContent = m.total_test_runs + ' test runs';
  document.getElementById('metaUpdated').textContent = m.generated_at ? m.generated_at.replace('T', ' ').slice(0, 19) : '--';
}

// ============================================================
// Summary Cards (Test Matrix tab)
// ============================================================
function renderSummaryCards() {
  const iters = DATA.iterations || [];
  const latest = iters[iters.length - 1];
  const prev = iters.length > 1 ? iters[iters.length - 2] : null;
  const reg = DATA.question_registry || {};

  const totalQ = Object.keys(reg).length;
  const passing = Object.values(reg).filter(q => q.current_status === 'pass').length;
  const failing = Object.values(reg).filter(q => q.current_status === 'fail').length;
  const errors = Object.values(reg).filter(q => q.current_status === 'error').length;
  const improving = Object.values(reg).filter(q => q.trend === 'improving').length;
  const regressing = Object.values(reg).filter(q => q.trend === 'regressing').length;

  const latestAcc = latest ? latest.overall_accuracy_pct : 0;
  const prevAcc = prev ? prev.overall_accuracy_pct : null;
  const delta = prevAcc !== null ? (latestAcc - prevAcc) : null;

  const cards = [
    {
      value: latestAcc.toFixed(1) + '%',
      label: 'Latest Accuracy',
      delta: delta !== null ? (delta >= 0 ? '+' : '') + delta.toFixed(1) + 'pp' : null,
      deltaDir: delta !== null ? (delta > 0 ? 'up' : delta < 0 ? 'down' : 'flat') : 'flat',
      color: latestAcc >= 75 ? 'var(--gn)' : latestAcc >= 60 ? 'var(--yl)' : 'var(--rd)'
    },
    {
      value: passing + '/' + totalQ,
      label: 'Passing',
      delta: null,
      color: 'var(--gn)'
    },
    {
      value: failing + errors,
      label: 'Failing + Errors',
      delta: null,
      color: (failing + errors) > 0 ? 'var(--rd)' : 'var(--gn)'
    },
    {
      value: improving + ' / ' + regressing,
      label: 'Improving / Regressing',
      delta: null,
      color: improving > regressing ? 'var(--gn)' : 'var(--yl)'
    }
  ];

  document.getElementById('summaryCards').innerHTML = cards.map(c => `
    <div class="card stat">
      <div class="value" style="color:${c.color}">${c.value}</div>
      <div class="label">${c.label}</div>
      ${c.delta ? `<div class="delta delta-${c.deltaDir}">${c.delta}</div>` : ''}
    </div>
  `).join('');
}

// ============================================================
// Test Matrix
// ============================================================
function renderMatrix() {
  const iters = DATA.iterations || [];
  const reg = DATA.question_registry || {};

  // Build header
  let headerHtml = '<tr><th>ID</th><th>Pipeline</th><th style="min-width:200px">Question</th><th>Status</th>';
  iters.forEach(iter => {
    headerHtml += `<th class="mono" style="text-align:center;min-width:75px" title="${iter.label}\n${iter.description}">Iter ${iter.number}<br><span style="font-size:10px;color:var(--tx3)">${iter.total_tested}q</span></th>`;
  });
  headerHtml += '<th>Trend</th></tr>';
  document.getElementById('matrixHeader').innerHTML = headerHtml;

  // Build lookup: iteration_id -> {question_id -> result}
  const iterLookup = {};
  iters.forEach(iter => {
    const map = {};
    iter.questions.forEach(q => { map[q.id] = q; });
    iterLookup[iter.id] = map;
  });

  // Get filter values
  const pipeFilter = document.getElementById('matrixPipeFilter').value;
  const statusFilter = document.getElementById('matrixStatusFilter').value;
  const searchText = document.getElementById('matrixSearch').value.toLowerCase();

  // Sort questions by pipeline then ID
  const sortedQids = Object.keys(reg).sort((a, b) => {
    const qa = reg[a], qb = reg[b];
    if (qa.rag_type !== qb.rag_type) return qa.rag_type.localeCompare(qb.rag_type);
    return a.localeCompare(b);
  });

  let bodyHtml = '';
  let prevPipe = '';
  let visibleCount = 0;

  sortedQids.forEach(qid => {
    const q = reg[qid];

    // Filters
    if (pipeFilter !== 'all' && q.rag_type !== pipeFilter) return;
    if (statusFilter !== 'all') {
      if (statusFilter === 'pass' && q.current_status !== 'pass') return;
      if (statusFilter === 'fail' && q.current_status !== 'fail') return;
      if (statusFilter === 'error' && q.current_status !== 'error') return;
      if (statusFilter === 'improving' && q.trend !== 'improving') return;
      if (statusFilter === 'regressing' && q.trend !== 'regressing') return;
    }
    if (searchText && !qid.toLowerCase().includes(searchText) &&
        !q.question.toLowerCase().includes(searchText) &&
        !q.expected.toLowerCase().includes(searchText)) return;

    // Pipeline separator
    if (q.rag_type !== prevPipe) {
      bodyHtml += `<tr><td colspan="${4 + iters.length + 1}" style="background:var(--s3);padding:6px 10px;font-weight:600;font-size:11px;text-transform:uppercase;color:var(--tx2)">${q.rag_type} RAG</td></tr>`;
      prevPipe = q.rag_type;
    }

    const statusTag = q.current_status === 'pass' ? '<span class="tag tag-pass">PASS</span>' :
                       q.current_status === 'error' ? '<span class="tag tag-error">ERR</span>' :
                       '<span class="tag tag-fail">FAIL</span>';

    const trendTag = q.trend === 'improving' ? '<span class="tag tag-improving">UP</span>' :
                     q.trend === 'regressing' ? '<span class="tag tag-regressing">DOWN</span>' :
                     '<span class="tag tag-stable">--</span>';

    bodyHtml += `<tr onclick="showQuestionDetail('${qid}')" style="cursor:pointer">`;
    bodyHtml += `<td class="mono" style="font-size:11px">${qid}</td>`;
    bodyHtml += `<td><span class="pipe-${q.rag_type}" style="font-size:11px;font-weight:600">${q.rag_type.slice(0,4).toUpperCase()}</span></td>`;
    bodyHtml += `<td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(q.question)}">${escHtml(q.question.slice(0, 80))}</td>`;
    bodyHtml += `<td>${statusTag}</td>`;

    // Iteration cells
    iters.forEach(iter => {
      const result = iterLookup[iter.id]?.[qid];
      if (!result) {
        bodyHtml += '<td class="cell-skip">-</td>';
      } else if (result.error) {
        bodyHtml += `<td class="cell-error" title="Error: ${escHtml(String(result.error).slice(0,100))}">E</td>`;
      } else if (result.correct) {
        const f1 = result.f1 ? result.f1.toFixed(2) : '';
        bodyHtml += `<td class="cell-pass" title="F1: ${f1}, ${result.latency_ms}ms">${f1 || 'P'}</td>`;
      } else {
        const f1 = result.f1 ? result.f1.toFixed(2) : '';
        bodyHtml += `<td class="cell-fail" title="F1: ${f1}, ${result.match_type}">${f1 || 'F'}</td>`;
      }
    });

    bodyHtml += `<td>${trendTag}</td>`;
    bodyHtml += '</tr>';
    visibleCount++;
  });

  document.getElementById('matrixBody').innerHTML = bodyHtml;
  document.getElementById('matrixFilterInfo').textContent = `(${visibleCount} of ${sortedQids.length} questions)`;
}

// Matrix filters
['matrixPipeFilter', 'matrixStatusFilter', 'matrixSearch'].forEach(id => {
  document.getElementById(id).addEventListener(id === 'matrixSearch' ? 'input' : 'change', renderMatrix);
});

// ============================================================
// Question Detail (shown below matrix)
// ============================================================
function showQuestionDetail(qid) {
  const reg = DATA.question_registry || {};
  const q = reg[qid];
  if (!q) return;
  selectedQuestion = qid;

  let html = `<h3 style="font-size:14px;font-weight:600;margin-bottom:10px">${qid} — ${escHtml(q.question)}</h3>`;
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;font-size:12px;color:var(--tx2)">`;
  html += `<span>Pipeline: <strong class="pipe-${q.rag_type}">${q.rag_type}</strong></span>`;
  html += `<span>Category: <strong>${q.category || 'N/A'}</strong></span>`;
  html += `<span>Pass rate: <strong>${(q.pass_rate * 100).toFixed(0)}%</strong> (${q.pass_count}/${q.total_runs})</span>`;
  html += `<span>Best F1: <strong>${q.best_f1.toFixed(3)}</strong></span>`;
  html += `<span>Trend: <span class="tag tag-${q.trend}">${q.trend}</span></span>`;
  if (q.entities?.length) html += `<span>Entities: <code>${q.entities.join(', ')}</code></span>`;
  if (q.tables?.length) html += `<span>Tables: <code>${q.tables.join(', ')}</code></span>`;
  html += `</div>`;

  html += `<div style="margin-bottom:8px"><strong style="font-size:11px;color:var(--tx2)">EXPECTED ANSWER:</strong></div>`;
  html += `<div class="answer-block expected">${escHtml(q.expected)}${q.expected_detail ? '\n\n' + escHtml(q.expected_detail) : ''}</div>`;

  html += `<div style="margin-top:12px"><strong style="font-size:11px;color:var(--tx2)">TEST RUNS (${q.runs.length}):</strong></div>`;
  html += `<table style="margin-top:6px"><thead><tr><th>Iter</th><th>Result</th><th>F1</th><th>Latency</th><th>Method</th><th>Answer</th></tr></thead><tbody>`;

  q.runs.forEach(run => {
    const tag = run.error ? '<span class="tag tag-error">ERR</span>' :
                run.correct ? '<span class="tag tag-pass">PASS</span>' :
                '<span class="tag tag-fail">FAIL</span>';
    const answer = run.error ? `<span style="color:var(--rd)">${escHtml(String(run.error).slice(0, 120))}</span>` :
                   escHtml(run.answer?.slice(0, 150) || '(empty)');
    html += `<tr>
      <td class="mono">${run.iteration_number}</td>
      <td>${tag}</td>
      <td class="mono">${run.f1.toFixed(3)}</td>
      <td class="mono">${run.latency_ms}ms</td>
      <td><span class="mono" style="font-size:10px">${run.match_type || '-'}</span></td>
      <td style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(run.answer || '')}">${answer}</td>
    </tr>`;
  });

  html += '</tbody></table>';

  const panel = document.getElementById('questionDetail');
  panel.innerHTML = html;
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ============================================================
// Iterations Tab
// ============================================================
function renderIterations() {
  const iters = DATA.iterations || [];

  // Timeline
  let timeHtml = '';
  iters.slice().reverse().forEach(iter => {
    const acc = iter.overall_accuracy_pct;
    const accColor = acc >= 75 ? 'var(--gn)' : acc >= 60 ? 'var(--yl)' : 'var(--rd)';

    timeHtml += `<div class="timeline-item">`;
    timeHtml += `<div class="time">${iter.timestamp_start.replace('T', ' ').slice(0, 19)}</div>`;
    timeHtml += `<h4>${iter.label} <span style="color:${accColor};font-size:13px">(${acc}%)</span></h4>`;
    if (iter.description) timeHtml += `<div class="changes">${escHtml(iter.description)}</div>`;
    if (iter.changes_applied?.length) {
      timeHtml += `<div class="changes" style="border-left:2px solid var(--ac);padding-left:8px;margin-bottom:8px">`;
      iter.changes_applied.forEach(c => { timeHtml += `<div style="margin-bottom:2px">${escHtml(c)}</div>`; });
      timeHtml += `</div>`;
    }

    timeHtml += `<div class="metrics">`;
    for (const [rt, rs] of Object.entries(iter.results_summary || {})) {
      const eRate = rs.tested > 0 ? (rs.errors / rs.tested * 100).toFixed(0) : 0;
      timeHtml += `<div class="metric"><span class="pipe-${rt}" style="font-weight:600">${rt.slice(0,4).toUpperCase()}</span>: <strong>${rs.accuracy_pct}%</strong> (${rs.correct}/${rs.tested}) <span style="color:var(--tx3)">${rs.avg_latency_ms}ms, ${eRate}% err</span></div>`;
    }
    timeHtml += `</div></div>`;
  });
  document.getElementById('iterTimeline').innerHTML = timeHtml;

  // Comparison dropdowns
  const selA = document.getElementById('iterCompareA');
  const selB = document.getElementById('iterCompareB');
  selA.innerHTML = iters.map(i => `<option value="${i.id}">Iter ${i.number}: ${i.label}</option>`).join('');
  selB.innerHTML = iters.map(i => `<option value="${i.id}">Iter ${i.number}: ${i.label}</option>`).join('');
  if (iters.length > 1) {
    selA.value = iters[iters.length - 2].id;
    selB.value = iters[iters.length - 1].id;
  }

  // Chart
  renderIterChart(iters);
}

function renderIterChart(iters) {
  const ctx = document.getElementById('iterChart');
  if (!ctx) return;
  if (charts.iter) charts.iter.destroy();

  const labels = iters.map(i => 'Iter ' + i.number);
  const pipes = ['standard', 'graph', 'quantitative', 'orchestrator'];
  const colors = { standard: '#4f8efa', graph: '#a060f0', quantitative: '#20c0d8', orchestrator: '#f08030' };

  const datasets = pipes.map(p => ({
    label: p.charAt(0).toUpperCase() + p.slice(1),
    data: iters.map(i => i.results_summary?.[p]?.accuracy_pct ?? null),
    borderColor: colors[p],
    backgroundColor: colors[p] + '20',
    fill: false,
    tension: 0.3,
    pointRadius: 5,
    pointHoverRadius: 7,
    spanGaps: true,
  }));

  // Add overall
  datasets.push({
    label: 'Overall',
    data: iters.map(i => i.overall_accuracy_pct),
    borderColor: '#ffffff',
    borderDash: [5, 3],
    fill: false,
    tension: 0.3,
    pointRadius: 5,
    pointHoverRadius: 7,
  });

  charts.iter = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#8896a8', font: { size: 11 } } },
        tooltip: {
          callbacks: {
            afterLabel: (ctx) => {
              const iter = iters[ctx.dataIndex];
              const pipe = pipes[ctx.datasetIndex] || 'overall';
              const rs = iter.results_summary?.[pipe];
              if (!rs) return '';
              return `${rs.correct}/${rs.tested} correct, ${rs.errors} errors, ${rs.avg_latency_ms}ms avg`;
            }
          }
        }
      },
      scales: {
        y: { min: 0, max: 100, grid: { color: '#1e2533' }, ticks: { color: '#5a6578', callback: v => v + '%' } },
        x: { grid: { color: '#1e2533' }, ticks: { color: '#5a6578' } }
      }
    }
  });
}

function compareIterations() {
  const idA = document.getElementById('iterCompareA').value;
  const idB = document.getElementById('iterCompareB').value;
  const iters = DATA.iterations || [];
  const iterA = iters.find(i => i.id === idA);
  const iterB = iters.find(i => i.id === idB);
  if (!iterA || !iterB) return;

  // Build question maps
  const mapA = {};
  iterA.questions.forEach(q => { mapA[q.id] = q; });
  const mapB = {};
  iterB.questions.forEach(q => { mapB[q.id] = q; });

  // Find common questions
  const allIds = new Set([...Object.keys(mapA), ...Object.keys(mapB)]);
  const improved = [], regressed = [], fixed = [], broken = [], same = [];

  allIds.forEach(qid => {
    const a = mapA[qid];
    const b = mapB[qid];
    if (!a || !b) return; // only in one iteration
    if (!a.correct && b.correct) fixed.push({ qid, a, b });
    else if (a.correct && !b.correct) broken.push({ qid, a, b });
    else if (a.correct && b.correct && b.f1 > a.f1 + 0.05) improved.push({ qid, a, b });
    else if (a.correct && b.correct && a.f1 > b.f1 + 0.05) regressed.push({ qid, a, b });
    else same.push({ qid, a, b });
  });

  let html = `<div style="margin-top:12px">`;
  html += `<div style="font-size:12px;color:var(--tx2);margin-bottom:10px">Comparing ${allIds.size} questions common to both iterations</div>`;

  // Summary
  html += `<div class="grid g4" style="margin-bottom:12px">`;
  html += `<div class="card stat"><div class="value" style="color:var(--gn)">${fixed.length}</div><div class="label">Fixed (was fail, now pass)</div></div>`;
  html += `<div class="card stat"><div class="value" style="color:var(--rd)">${broken.length}</div><div class="label">Broken (was pass, now fail)</div></div>`;
  html += `<div class="card stat"><div class="value" style="color:var(--ac)">${improved.length}</div><div class="label">Improved F1</div></div>`;
  html += `<div class="card stat"><div class="value" style="color:var(--yl)">${regressed.length}</div><div class="label">Regressed F1</div></div>`;
  html += `</div>`;

  // Detail tables
  if (fixed.length > 0) {
    html += renderCompareTable('Fixed (fail -> pass)', fixed, 'gn');
  }
  if (broken.length > 0) {
    html += renderCompareTable('Broken (pass -> fail)', broken, 'rd');
  }
  if (regressed.length > 0) {
    html += renderCompareTable('F1 Regressed', regressed, 'yl');
  }

  html += `</div>`;
  document.getElementById('iterCompareResult').innerHTML = html;
}

function renderCompareTable(title, items, colorVar) {
  let html = `<div style="margin-top:12px"><strong style="font-size:12px;color:var(--${colorVar})">${title} (${items.length})</strong>`;
  html += `<table style="margin-top:4px"><thead><tr><th>ID</th><th>Iter A</th><th>Iter B</th><th>F1 Change</th><th>Answer B</th></tr></thead><tbody>`;
  items.forEach(({ qid, a, b }) => {
    const deltaF1 = (b.f1 - a.f1).toFixed(3);
    const color = b.f1 > a.f1 ? 'var(--gn)' : b.f1 < a.f1 ? 'var(--rd)' : 'var(--tx3)';
    html += `<tr>
      <td class="mono">${qid}</td>
      <td>${a.correct ? '<span class="tag tag-pass">PASS</span>' : '<span class="tag tag-fail">FAIL</span>'} ${a.f1.toFixed(3)}</td>
      <td>${b.correct ? '<span class="tag tag-pass">PASS</span>' : '<span class="tag tag-fail">FAIL</span>'} ${b.f1.toFixed(3)}</td>
      <td class="mono" style="color:${color}">${deltaF1 > 0 ? '+' : ''}${deltaF1}</td>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml((b.answer || '').slice(0, 120))}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  return html;
}

// ============================================================
// Questions Tab
// ============================================================
function renderQuestions() {
  const reg = DATA.question_registry || {};
  const searchText = document.getElementById('qSearch').value.toLowerCase();
  const pipeFilter = document.getElementById('qPipeFilter').value;
  const statusFilter = document.getElementById('qStatusFilter').value;

  const sorted = Object.values(reg).sort((a, b) => {
    if (a.rag_type !== b.rag_type) return a.rag_type.localeCompare(b.rag_type);
    return a.id.localeCompare(b.id);
  });

  let html = '';
  sorted.forEach(q => {
    if (pipeFilter !== 'all' && q.rag_type !== pipeFilter) return;
    if (statusFilter === 'pass' && q.current_status !== 'pass') return;
    if (statusFilter === 'fail' && q.current_status !== 'fail' && q.current_status !== 'error') return;
    if (statusFilter === 'error' && !q.runs.some(r => r.error)) return;
    if (statusFilter === 'improving' && q.trend !== 'improving') return;
    if (statusFilter === 'regressing' && q.trend !== 'regressing') return;
    if (searchText && !q.id.toLowerCase().includes(searchText) &&
        !q.question.toLowerCase().includes(searchText) &&
        !q.expected.toLowerCase().includes(searchText)) return;

    const statusTag = q.current_status === 'pass' ? '<span class="tag tag-pass">PASS</span>' :
                      q.current_status === 'error' ? '<span class="tag tag-error">ERR</span>' :
                      '<span class="tag tag-fail">FAIL</span>';
    const trendTag = q.trend === 'improving' ? '<span class="tag tag-improving">UP</span>' :
                     q.trend === 'regressing' ? '<span class="tag tag-regressing">DOWN</span>' :
                     '<span class="tag tag-stable">--</span>';

    html += `<tr onclick="showQDetail('${q.id}')" style="cursor:pointer">
      <td class="mono" style="font-size:11px">${q.id}</td>
      <td style="max-width:350px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(q.question)}">${escHtml(q.question.slice(0, 90))}</td>
      <td><span class="pipe-${q.rag_type}" style="font-size:11px;font-weight:600">${q.rag_type.slice(0,5)}</span></td>
      <td class="mono">${q.total_runs}</td>
      <td class="mono">${(q.pass_rate * 100).toFixed(0)}%</td>
      <td class="mono">${q.best_f1.toFixed(3)}</td>
      <td>${statusTag}</td>
      <td>${trendTag}</td>
    </tr>`;
  });

  document.getElementById('questionsBody').innerHTML = html;
}

function showQDetail(qid) {
  const reg = DATA.question_registry || {};
  const q = reg[qid];
  if (!q) return;

  let html = `<h3 style="font-size:14px;font-weight:600;margin-bottom:10px">${qid}: ${escHtml(q.question)}</h3>`;
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px;font-size:12px;color:var(--tx2)">
    <span>Pipeline: <strong class="pipe-${q.rag_type}">${q.rag_type}</strong></span>
    <span>Category: <strong>${q.category || 'N/A'}</strong></span>
    <span>Pass rate: <strong>${(q.pass_rate * 100).toFixed(0)}%</strong></span>
    <span>Best F1: <strong>${q.best_f1.toFixed(3)}</strong></span>
  </div>`;

  html += `<div style="margin-bottom:6px"><strong style="font-size:11px;color:var(--gn)">EXPECTED:</strong></div>`;
  html += `<div class="answer-block expected">${escHtml(q.expected)}</div>`;

  html += `<div style="margin-top:10px"><strong style="font-size:11px;color:var(--tx2)">ALL RUNS:</strong></div>`;
  html += `<table style="margin-top:4px"><thead><tr><th>Iter</th><th>Result</th><th>F1</th><th>Latency</th><th>Method</th><th>Answer / Error</th></tr></thead><tbody>`;

  q.runs.forEach(r => {
    const tag = r.error ? '<span class="tag tag-error">ERR</span>' :
                r.correct ? '<span class="tag tag-pass">PASS</span>' :
                '<span class="tag tag-fail">FAIL</span>';
    const content = r.error ? `<span style="color:var(--rd)">${escHtml(String(r.error).slice(0, 200))}</span>` :
                    escHtml((r.answer || '(empty)').slice(0, 200));
    html += `<tr>
      <td class="mono">${r.iteration_number}</td>
      <td>${tag}</td>
      <td class="mono">${r.f1.toFixed(3)}</td>
      <td class="mono">${r.latency_ms}ms</td>
      <td class="mono" style="font-size:10px">${r.match_type || '-'}</td>
      <td style="max-width:500px;white-space:pre-wrap;word-break:break-word;font-size:12px">${content}</td>
    </tr>`;
  });

  html += `</tbody></table>`;

  const panel = document.getElementById('qDetailPanel');
  panel.innerHTML = html;
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

['qSearch', 'qPipeFilter', 'qStatusFilter'].forEach(id => {
  document.getElementById(id).addEventListener(id === 'qSearch' ? 'input' : 'change', renderQuestions);
});

// ============================================================
// Pipelines Tab
// ============================================================
function renderPipelines() {
  const pipes = DATA.pipelines || {};
  const iters = DATA.iterations || [];
  const reg = DATA.question_registry || {};

  // Pipeline summary cards
  let cardsHtml = '';
  const pipeNames = ['standard', 'graph', 'quantitative', 'orchestrator'];
  const pipeColors = { standard: '#4f8efa', graph: '#a060f0', quantitative: '#20c0d8', orchestrator: '#f08030' };

  pipeNames.forEach(name => {
    const pipe = pipes[name] || {};
    const trend = pipe.trend || [];
    const latest = trend[trend.length - 1] || {};
    const prev = trend.length > 1 ? trend[trend.length - 2] : null;
    const delta = prev ? (latest.accuracy_pct - prev.accuracy_pct) : null;
    const target = pipe.target_accuracy || 85;
    const acc = latest.accuracy_pct || 0;
    const fillW = Math.min(acc / 100 * 100, 100);
    const targetW = target;
    const fillColor = acc >= target ? 'var(--gn)' : acc >= target - 10 ? 'var(--yl)' : 'var(--rd)';

    const qCount = Object.values(reg).filter(q => q.rag_type === name).length;
    const passing = Object.values(reg).filter(q => q.rag_type === name && q.current_status === 'pass').length;

    cardsHtml += `<div class="card">
      <h3 style="color:${pipeColors[name]}">${name.toUpperCase()}</h3>
      <div class="stat" style="margin-bottom:10px">
        <div class="value" style="color:${fillColor}">${acc.toFixed(1)}%</div>
        <div class="label">Accuracy (target: ${target}%)</div>
        ${delta !== null ? `<div class="delta ${delta >= 0 ? 'delta-up' : 'delta-down'}">${delta >= 0 ? '+' : ''}${delta.toFixed(1)}pp</div>` : ''}
      </div>
      <div class="acc-bar" style="margin-bottom:8px">
        <div class="fill" style="width:${fillW}%;background:${fillColor}"></div>
        <div class="target" style="left:${targetW}%"></div>
      </div>
      <div style="font-size:11px;color:var(--tx2);display:flex;justify-content:space-between">
        <span>${passing}/${qCount} passing</span>
        <span>${latest.errors || 0} errors</span>
        <span>${latest.avg_latency_ms || 0}ms</span>
      </div>
    </div>`;
  });
  document.getElementById('pipelineCards').innerHTML = cardsHtml;

  // Charts
  renderPipeCharts(iters, pipeNames, pipeColors);

  // Category breakdown
  renderCategoryBreakdown(reg);
}

function renderPipeCharts(iters, pipeNames, colors) {
  const labels = iters.map(i => 'Iter ' + i.number);

  // Accuracy chart
  if (charts.pipeAcc) charts.pipeAcc.destroy();
  charts.pipeAcc = new Chart(document.getElementById('pipeAccChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: pipeNames.map(p => ({
        label: p.charAt(0).toUpperCase() + p.slice(1),
        data: iters.map(i => i.results_summary?.[p]?.accuracy_pct ?? null),
        backgroundColor: colors[p] + '80',
        borderColor: colors[p],
        borderWidth: 1,
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#8896a8', font: { size: 11 } } } },
      scales: {
        y: { min: 0, max: 100, grid: { color: '#1e2533' }, ticks: { color: '#5a6578', callback: v => v + '%' } },
        x: { grid: { color: '#1e2533' }, ticks: { color: '#5a6578' } }
      }
    }
  });

  // Error rate chart
  if (charts.pipeErr) charts.pipeErr.destroy();
  charts.pipeErr = new Chart(document.getElementById('pipeErrChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: pipeNames.map(p => ({
        label: p.charAt(0).toUpperCase() + p.slice(1),
        data: iters.map(i => {
          const rs = i.results_summary?.[p];
          return rs && rs.tested > 0 ? (rs.errors / rs.tested * 100).toFixed(1) : null;
        }),
        backgroundColor: colors[p] + '60',
        borderColor: colors[p],
        borderWidth: 1,
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#8896a8', font: { size: 11 } } } },
      scales: {
        y: { min: 0, grid: { color: '#1e2533' }, ticks: { color: '#5a6578', callback: v => v + '%' } },
        x: { grid: { color: '#1e2533' }, ticks: { color: '#5a6578' } }
      }
    }
  });

  // Latency chart
  if (charts.pipeLat) charts.pipeLat.destroy();
  charts.pipeLat = new Chart(document.getElementById('pipeLatChart'), {
    type: 'line',
    data: {
      labels,
      datasets: pipeNames.map(p => ({
        label: p.charAt(0).toUpperCase() + p.slice(1),
        data: iters.map(i => i.results_summary?.[p]?.avg_latency_ms ?? null),
        borderColor: colors[p],
        fill: false,
        tension: 0.3,
        pointRadius: 5,
        spanGaps: true,
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#8896a8', font: { size: 11 } } } },
      scales: {
        y: { min: 0, grid: { color: '#1e2533' }, ticks: { color: '#5a6578', callback: v => v + 'ms' } },
        x: { grid: { color: '#1e2533' }, ticks: { color: '#5a6578' } }
      }
    }
  });
}

function renderCategoryBreakdown(reg) {
  const byCat = {};
  Object.values(reg).forEach(q => {
    const cat = q.category || 'uncategorized';
    if (!byCat[cat]) byCat[cat] = { total: 0, pass: 0, fail: 0, error: 0 };
    byCat[cat].total++;
    if (q.current_status === 'pass') byCat[cat].pass++;
    else if (q.current_status === 'error') byCat[cat].error++;
    else byCat[cat].fail++;
  });

  let html = '<table><thead><tr><th>Category</th><th>Total</th><th>Pass</th><th>Fail</th><th>Error</th><th>Accuracy</th></tr></thead><tbody>';
  Object.entries(byCat).sort((a, b) => b[1].total - a[1].total).forEach(([cat, info]) => {
    const acc = (info.pass / info.total * 100).toFixed(0);
    const accColor = acc >= 75 ? 'var(--gn)' : acc >= 50 ? 'var(--yl)' : 'var(--rd)';
    html += `<tr>
      <td class="mono" style="font-size:11px">${cat}</td>
      <td>${info.total}</td>
      <td style="color:var(--gn)">${info.pass}</td>
      <td style="color:var(--rd)">${info.fail}</td>
      <td style="color:var(--yl)">${info.error}</td>
      <td style="color:${accColor};font-weight:600">${acc}%</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('categoryBreakdown').innerHTML = html;
}

// ============================================================
// Changes Log Tab
// ============================================================
function renderChanges() {
  const changes = DATA.workflow_changes || [];
  const snapshots = DATA.db_snapshots || [];

  let html = '';
  changes.slice().reverse().forEach(c => {
    html += `<tr>
      <td class="mono" style="font-size:11px">${c.timestamp.replace('T', ' ').slice(0, 19)}</td>
      <td><span class="tag" style="background:rgba(79,142,250,.12);color:var(--ac)">${c.change_type || 'mod'}</span></td>
      <td>${escHtml(c.description)}</td>
      <td>${(c.affected_pipelines || []).map(p => `<span class="pipe-${p}" style="font-size:11px;font-weight:600">${p.slice(0,4)}</span>`).join(' ')}</td>
      <td>${c.after_metrics ? formatDelta(c.before_metrics, c.after_metrics) : '-'}</td>
    </tr>`;
  });
  document.getElementById('changesBody').innerHTML = html;

  // DB Snapshots
  let snapHtml = '';
  snapshots.slice().reverse().forEach(s => {
    snapHtml += `<tr>
      <td class="mono" style="font-size:11px">${s.timestamp.replace('T', ' ').slice(0, 19)}</td>
      <td><span class="tag" style="background:rgba(79,142,250,.12);color:var(--ac)">${s.trigger}</span></td>
      <td class="mono">${(s.pinecone_vectors || 0).toLocaleString()}</td>
      <td class="mono">${(s.neo4j_nodes || 0).toLocaleString()}</td>
      <td class="mono">${(s.neo4j_relationships || 0).toLocaleString()}</td>
      <td class="mono">${(s.supabase_rows || 0).toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById('dbSnapshotsBody').innerHTML = snapHtml;
}

function formatDelta(before, after) {
  if (!before || !after) return '-';
  // Simple: show accuracy changes
  let parts = [];
  for (const [pipe, metrics] of Object.entries(after)) {
    const b = before[pipe];
    if (b && metrics.accuracy !== undefined && b.accuracy !== undefined) {
      const d = metrics.accuracy - b.accuracy;
      parts.push(`<span class="${d >= 0 ? 'delta-up' : 'delta-down'}">${pipe.slice(0,4)}: ${d >= 0 ? '+' : ''}${d.toFixed(1)}%</span>`);
    }
  }
  return parts.join(' ') || '-';
}

// ============================================================
// Agentic API Tab
// ============================================================
function renderAPI() {
  const schema = {
    "meta": "{ version, status, phase, total_unique_questions, total_test_runs, total_iterations }",
    "iterations[]": {
      "id": "iter-001",
      "number": 1,
      "label": "string — human label",
      "description": "string — what changed",
      "changes_applied": ["string — workflow changes before this run"],
      "results_summary": {
        "[pipeline]": "{ tested, correct, errors, accuracy_pct, avg_latency_ms, p95_latency_ms, avg_f1 }"
      },
      "questions[]": "{ id, rag_type, correct, f1, latency_ms, answer, expected, match_type, error }"
    },
    "question_registry": {
      "[question_id]": {
        "question": "string",
        "expected": "string",
        "rag_type": "standard|graph|quantitative|orchestrator",
        "category": "string",
        "runs[]": "{ iteration_id, correct, f1, latency_ms, match_type, answer, error }",
        "current_status": "pass|fail|error",
        "pass_rate": 0.85,
        "trend": "improving|regressing|stable",
        "best_f1": 0.95
      }
    },
    "pipelines": {
      "[name]": "{ endpoint, target_accuracy, trend[] }"
    },
    "workflow_changes[]": "{ timestamp, description, change_type, affected_pipelines, before_metrics, after_metrics }",
    "quick_tests[]": "{ timestamp, endpoint, status, latency_ms, response_preview }"
  };

  document.getElementById('apiSchema').textContent = JSON.stringify(schema, null, 2);

  document.getElementById('agenticRules').innerHTML = `
    <div style="margin-bottom:16px">
      <p>An agentic evaluator should follow these rules when analyzing <code>data.json</code>:</p>
      <ol style="padding-left:20px;margin-top:8px;line-height:2">
        <li><strong>Identify regressions:</strong> Compare latest iteration with previous. Any question that changed from PASS to FAIL is a regression that must be investigated.</li>
        <li><strong>Analyze error patterns:</strong> Group errors by <code>error_type</code> (TIMEOUT, EMPTY_RESPONSE, ENTITY_MISS, SQL_ERROR). High concentration in one type = targeted fix needed.</li>
        <li><strong>Track question stability:</strong> Questions with <code>pass_rate &lt; 0.5</code> across 3+ runs are "flaky" and need investigation.</li>
        <li><strong>Compare pipeline targets:</strong> Check <code>pipelines.[name].target_accuracy</code> vs latest iteration accuracy. Gap > 10pp = priority improvement area.</li>
        <li><strong>Propose improvements only with data:</strong> Never propose changes unless the accuracy is plateaued for 2+ iterations or error rate > 15%.</li>
        <li><strong>Quick test after changes:</strong> After any workflow modification, run a quick test (3-5 known-good questions) before full eval. Log results in <code>quick_tests[]</code>.</li>
        <li><strong>Version everything:</strong> Record the exact workflow change description, affected pipelines, and before/after metrics in <code>workflow_changes[]</code>.</li>
        <li><strong>Fail-fast on regressions:</strong> If a quick test shows regression on previously-passing questions, revert immediately.</li>
      </ol>
    </div>
  `;

  document.getElementById('ghActionsDoc').innerHTML = `
    <div style="font-size:12.5px;color:var(--tx2)">
      <p>Three GitHub Actions workflows are configured:</p>
      <table style="margin-top:8px">
        <thead><tr><th>Workflow</th><th>Trigger</th><th>Purpose</th></tr></thead>
        <tbody>
          <tr>
            <td class="mono">rag-eval.yml</td>
            <td>Daily 06:00 UTC + manual</td>
            <td>Runs <code>run-comprehensive-eval.py</code>, commits results to <code>docs/data.json</code>, generates GitHub Step Summary</td>
          </tr>
          <tr>
            <td class="mono">n8n-error-log.yml</td>
            <td><code>repository_dispatch</code></td>
            <td>Receives error/execution logs from n8n workflows via GitHub API, writes to <code>logs/</code></td>
          </tr>
          <tr>
            <td class="mono">dashboard-deploy.yml</td>
            <td>Push to <code>docs/**</code></td>
            <td>Auto-deploys this dashboard to GitHub Pages</td>
          </tr>
          <tr>
            <td class="mono">agentic-eval.yml</td>
            <td>After eval + manual</td>
            <td>Runs agentic analysis on latest results, proposes improvements, opens issues</td>
          </tr>
        </tbody>
      </table>
      <p style="margin-top:10px">To trigger a manual evaluation:</p>
      <div class="answer-block" style="background:var(--s3);border-radius:6px;padding:8px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:4px">gh workflow run rag-eval.yml -f types=standard,graph -f max_per_type=50 -f reset=true</div>
    </div>
  `;
}

// ============================================================
// Utilities
// ============================================================
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ============================================================
// Init
// ============================================================
loadData();
setInterval(loadData, 15000); // Refresh every 15s
</script>
</body>
</html>
