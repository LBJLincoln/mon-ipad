<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAG Benchmark — SOTA 2026 Dashboard</title>
<style>
:root{--bg:#0a0e14;--s1:#12161e;--s2:#1a1f2b;--s3:#222838;--bd:#2a3040;--tx:#e2e8f0;--tx2:#8896a8;--tx3:#5a6578;--ac:#3b82f6;--ac2:#60a5fa;--gn:#22c55e;--gn2:#4ade80;--rd:#ef4444;--rd2:#f87171;--yl:#eab308;--yl2:#facc15;--or:#f97316;--pp:#a855f7;--pp2:#c084fc;--cy:#06b6d4;--pk:#ec4899;--gradient:linear-gradient(135deg,#3b82f6,#8b5cf6)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:14px;overflow-x:hidden}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
::selection{background:var(--ac);color:#fff}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--s1)}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--tx3)}

/* TOPBAR */
.topbar{background:var(--s1);border-bottom:1px solid var(--bd);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px)}
.topbar .brand{display:flex;align-items:center;gap:10px}
.topbar .brand svg{width:24px;height:24px}
.topbar h1{font-size:1em;font-weight:600;letter-spacing:-.02em}
.topbar .live{width:8px;height:8px;border-radius:50%;background:var(--gn);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.topbar .meta{color:var(--tx2);font-size:.8em;display:flex;gap:14px;align-items:center}
.tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.72em;font-weight:600;letter-spacing:.02em}
.t-ok{background:rgba(34,197,94,.12);color:var(--gn)}
.t-wr{background:rgba(234,179,8,.12);color:var(--yl)}
.t-er{background:rgba(239,68,68,.12);color:var(--rd)}
.t-in{background:rgba(59,130,246,.12);color:var(--ac)}
.t-pp{background:rgba(168,85,247,.12);color:var(--pp)}
.t-cy{background:rgba(6,182,212,.12);color:var(--cy)}
.t-or{background:rgba(249,115,22,.12);color:var(--or)}

/* TABS */
.tabs{display:flex;gap:0;background:var(--s1);border-bottom:1px solid var(--bd);padding:0 20px;overflow-x:auto}
.tab{padding:10px 18px;font-size:.85em;font-weight:500;color:var(--tx2);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;user-select:none}
.tab:hover{color:var(--tx);background:rgba(255,255,255,.02)}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tab-panel{display:none;padding:16px 20px;max-width:1480px;margin:0 auto}
.tab-panel.active{display:block}

/* CARDS & GRIDS */
.grid{display:grid;gap:12px;margin:12px 0}
.g5{grid-template-columns:repeat(5,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g2{grid-template-columns:1fr 1fr}
.g2-1{grid-template-columns:2fr 1fr}
.g1-2{grid-template-columns:1fr 2fr}
@media(max-width:1100px){.g5,.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.g5,.g4,.g3,.g2,.g2-1,.g1-2{grid-template-columns:1fr}}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:10px;padding:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--bd)}
.card.accent-blue::before{background:var(--ac)}
.card.accent-green::before{background:var(--gn)}
.card.accent-red::before{background:var(--rd)}
.card.accent-purple::before{background:var(--pp)}
.card.accent-yellow::before{background:var(--yl)}
.card.accent-cyan::before{background:var(--cy)}
.card .lbl{color:var(--tx2);font-size:.72em;text-transform:uppercase;letter-spacing:.06em;font-weight:500}
.card .val{font-size:2em;font-weight:700;margin:4px 0;line-height:1;letter-spacing:-.03em}
.card .sub{color:var(--tx2);font-size:.8em;margin-top:2px}
.card .delta{font-size:.75em;font-weight:600;padding:1px 6px;border-radius:4px;display:inline-block}
.delta-up{background:rgba(34,197,94,.12);color:var(--gn)}
.delta-dn{background:rgba(239,68,68,.12);color:var(--rd)}
.mono{font-family:'JetBrains Mono',monospace;font-size:.85em}

/* SECTION HEADERS */
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin:20px 0 10px}
.section-hdr h2{font-size:1em;font-weight:600;color:var(--tx);display:flex;align-items:center;gap:8px}
.section-hdr h2 .icon{color:var(--ac);font-size:1.1em}

/* TABLES */
table{width:100%;border-collapse:collapse;font-size:.85em}
thead th{background:var(--s2);color:var(--tx2);text-align:left;padding:8px 12px;border-bottom:1px solid var(--bd);font-weight:500;position:sticky;top:0;z-index:2;font-size:.78em;text-transform:uppercase;letter-spacing:.04em}
td{padding:8px 12px;border-bottom:1px solid rgba(42,48,64,.5)}
tr:hover td{background:rgba(59,130,246,.03)}
.tbl-wrap{border:1px solid var(--bd);border-radius:10px;overflow:hidden}

/* BARS & PROGRESS */
.bar{height:6px;border-radius:3px;background:var(--s3);overflow:hidden;display:flex}
.bar>div{height:100%;transition:width .8s cubic-bezier(.4,0,.2,1)}
.fill-gn{background:var(--gn)}.fill-yl{background:var(--yl)}.fill-rd{background:var(--rd)}.fill-ac{background:var(--ac)}.fill-pp{background:var(--pp)}.fill-cy{background:var(--cy)}
.accuracy-bar{height:24px;border-radius:6px;position:relative;background:var(--s3)}
.accuracy-bar .fill{height:100%;border-radius:6px;transition:width .8s}
.accuracy-bar .target{position:absolute;top:0;bottom:0;width:2px;background:var(--tx2);z-index:1}
.accuracy-bar .label{position:absolute;top:50%;transform:translateY(-50%);right:8px;font-size:.72em;font-weight:600;z-index:2}

/* CHARTS */
.chart-wrap{position:relative;margin:8px 0}
.chart-sm{height:160px}
.chart-md{height:220px}
.chart-lg{height:280px}
canvas{width:100%!important;height:100%!important}

/* FEED */
.feed{max-height:500px;overflow-y:auto;font-size:.82em}
.feed-row{padding:8px 12px;border-bottom:1px solid rgba(42,48,64,.4);display:grid;align-items:center;gap:8px;transition:background .15s}
.feed-row:hover{background:rgba(59,130,246,.04)}
.feed-hdr{font-weight:500;color:var(--tx2);position:sticky;top:0;background:var(--s2);z-index:1;text-transform:uppercase;font-size:.72em;letter-spacing:.04em}
.feed-row.expandable{cursor:pointer}
.feed-detail{display:none;padding:10px 12px;background:var(--s2);border-bottom:1px solid var(--bd);font-size:.82em;line-height:1.6}
.feed-detail.open{display:block}
.feed-6{grid-template-columns:70px 70px 1fr 80px 70px 60px}
.feed-7{grid-template-columns:70px 70px 1fr 80px 70px 60px 60px}

/* FILTERS */
.filters{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap;align-items:center}
.filters select,.filters input{background:var(--s2);color:var(--tx);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;font-size:.82em;outline:none;transition:border .2s}
.filters select:focus,.filters input:focus{border-color:var(--ac)}
.filters .btn{background:var(--s2);color:var(--tx2);border:1px solid var(--bd);border-radius:6px;padding:6px 12px;font-size:.82em;cursor:pointer;transition:all .2s}
.filters .btn:hover{background:var(--s3);color:var(--tx)}
.filters .btn.active{background:rgba(59,130,246,.15);color:var(--ac);border-color:var(--ac)}

/* ALERTS */
.alert{border-radius:8px;padding:12px 14px;margin:8px 0;display:flex;gap:10px;align-items:flex-start}
.alert .alert-icon{font-size:1.1em;flex-shrink:0;margin-top:1px}
.alert-danger{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2)}
.alert-warning{background:rgba(234,179,8,.06);border:1px solid rgba(234,179,8,.2)}
.alert-info{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.2)}
.alert-success{background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.2)}
.alert strong{font-size:.88em}
.alert .alert-body{font-size:.82em;color:var(--tx2);margin-top:2px}

/* HEATMAP */
.heatmap{display:grid;gap:2px}
.heatmap-cell{width:100%;aspect-ratio:1;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:.65em;font-weight:600;cursor:pointer;transition:transform .15s}
.heatmap-cell:hover{transform:scale(1.3);z-index:1}

/* COST BREAKDOWN */
.cost-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(42,48,64,.4)}
.cost-item:last-child{border-bottom:none}
.cost-item .cost-label{display:flex;align-items:center;gap:8px}
.cost-item .cost-dot{width:8px;height:8px;border-radius:50%}
.cost-item .cost-val{font-family:'JetBrains Mono',monospace;font-weight:500}

/* PIPELINE BADGE */
.pipe-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:.72em;font-weight:600}
.pipe-std{background:rgba(59,130,246,.12);color:var(--ac)}
.pipe-graph{background:rgba(168,85,247,.12);color:var(--pp)}
.pipe-quant{background:rgba(34,197,94,.12);color:var(--gn)}
.pipe-orch{background:rgba(249,115,22,.12);color:var(--or)}

/* TOOLTIP */
.tooltip{position:absolute;background:var(--s3);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;font-size:.78em;z-index:200;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,.4);max-width:300px}

/* FOOTER */
.footer{text-align:center;color:var(--tx3);font-size:.72em;padding:24px;border-top:1px solid var(--bd);margin-top:32px}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">
    <div class="live" id="live-dot"></div>
    <h1>RAG Benchmark Dashboard</h1>
    <span class="tag t-in" style="font-size:.68em">SOTA 2026</span>
  </div>
  <div class="meta">
    <span id="status-badge" class="tag t-in">LOADING</span>
    <span id="last-update">—</span>
    <span style="opacity:.4">|</span>
    <span id="refresh-timer">5s</span>
  </div>
</div>

<div class="tabs" id="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="pipelines">Pipelines</div>
  <div class="tab" data-tab="questions">Questions Explorer</div>
  <div class="tab" data-tab="costs">Costs & Resources</div>
  <div class="tab" data-tab="cross">Cross-Analysis</div>
  <div class="tab" data-tab="graph">Knowledge Graph</div>
</div>

<!-- ============================================================ -->
<!-- TAB: OVERVIEW -->
<!-- ============================================================ -->
<div class="tab-panel active" id="panel-overview">

  <!-- KPIs -->
  <div class="grid g5" id="kpi-row"></div>

  <!-- Pipeline Summary Cards -->
  <div class="section-hdr"><h2><span class="icon">&#9672;</span> Pipeline Performance</h2></div>
  <div class="grid g4" id="pipeline-cards"></div>

  <!-- Charts Row -->
  <div class="grid g2" style="margin-top:16px">
    <div class="card accent-blue">
      <div class="lbl">Accuracy Trend</div>
      <div class="chart-wrap chart-md"><canvas id="chart-accuracy"></canvas></div>
    </div>
    <div class="card accent-cyan">
      <div class="lbl">Latency Distribution (ms)</div>
      <div class="chart-wrap chart-md"><canvas id="chart-latency"></canvas></div>
    </div>
  </div>

  <!-- Alerts -->
  <div class="section-hdr"><h2><span class="icon">&#9888;</span> Alerts & Recommendations</h2></div>
  <div id="alerts"></div>

  <!-- DB Coverage -->
  <div class="section-hdr"><h2><span class="icon">&#9707;</span> Database Coverage</h2></div>
  <div class="grid g3" id="db-cards"></div>
</div>

<!-- ============================================================ -->
<!-- TAB: PIPELINES -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-pipelines">
  <div class="section-hdr"><h2><span class="icon">&#9672;</span> Pipeline Comparison</h2></div>
  <div class="tbl-wrap"><table id="pipeline-table">
    <thead><tr>
      <th>Pipeline</th><th>Progress</th><th>Accuracy</th><th>vs Target</th>
      <th>CI 95%</th><th>Errors</th><th>Avg Latency</th><th>P95</th>
      <th>F1 Mean</th><th>Cost</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>

  <div class="grid g2" style="margin-top:16px">
    <div class="card accent-purple">
      <div class="lbl">Accuracy vs Target (with CI)</div>
      <div class="chart-wrap chart-md"><canvas id="chart-acc-target"></canvas></div>
    </div>
    <div class="card accent-green">
      <div class="lbl">Error Rate by Pipeline</div>
      <div class="chart-wrap chart-md"><canvas id="chart-errors"></canvas></div>
    </div>
  </div>

  <div class="grid g2" style="margin-top:12px">
    <div class="card accent-cyan">
      <div class="lbl">F1 Score Distribution</div>
      <div class="chart-wrap chart-md"><canvas id="chart-f1-dist"></canvas></div>
    </div>
    <div class="card accent-yellow">
      <div class="lbl">Latency vs Accuracy Scatter</div>
      <div class="chart-wrap chart-md"><canvas id="chart-lat-acc"></canvas></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- TAB: QUESTIONS EXPLORER -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-questions">
  <div class="section-hdr">
    <h2><span class="icon">&#9776;</span> Questions Explorer <span id="feed-count" class="tag t-in" style="margin-left:6px">0</span></h2>
  </div>
  <div class="filters" id="question-filters">
    <select id="filter-type">
      <option value="">All Pipelines</option>
      <option value="standard">Standard</option>
      <option value="graph">Graph</option>
      <option value="quantitative">Quantitative</option>
      <option value="orchestrator">Orchestrator</option>
    </select>
    <select id="filter-status">
      <option value="">All Status</option>
      <option value="correct">Correct</option>
      <option value="incorrect">Incorrect</option>
      <option value="error">Error</option>
    </select>
    <select id="filter-f1">
      <option value="">All F1</option>
      <option value="high">F1 > 0.5</option>
      <option value="medium">F1 0.1-0.5</option>
      <option value="low">F1 < 0.1</option>
      <option value="zero">F1 = 0</option>
    </select>
    <input type="text" id="filter-search" placeholder="Search question or ID...">
    <div class="btn" id="btn-export">Export CSV</div>
  </div>

  <div class="tbl-wrap">
    <div class="feed-row feed-hdr feed-7">
      <div>ID</div><div>Pipeline</div><div>Question</div><div>F1</div><div>Latency</div><div>Match</div><div>Status</div>
    </div>
    <div class="feed" id="question-feed"></div>
  </div>

  <!-- Stats under feed -->
  <div class="grid g4" style="margin-top:12px" id="feed-stats"></div>
</div>

<!-- ============================================================ -->
<!-- TAB: COSTS & RESOURCES -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-costs">
  <div class="grid g4" id="cost-kpis"></div>

  <div class="grid g2" style="margin-top:16px">
    <div class="card accent-green">
      <div class="lbl">Cost Distribution by Pipeline</div>
      <div class="chart-wrap chart-md"><canvas id="chart-cost-pie"></canvas></div>
    </div>
    <div class="card accent-blue">
      <div class="lbl">Cost per Question by Pipeline</div>
      <div class="chart-wrap chart-md"><canvas id="chart-cost-per-q"></canvas></div>
    </div>
  </div>

  <div class="section-hdr"><h2><span class="icon">&#9733;</span> Estimated Cost Breakdown</h2></div>
  <div class="card" id="cost-breakdown"></div>

  <div class="section-hdr"><h2><span class="icon">&#9200;</span> Resource Utilization</h2></div>
  <div class="grid g3" id="resource-cards"></div>
</div>

<!-- ============================================================ -->
<!-- TAB: CROSS-ANALYSIS -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-cross">
  <div class="section-hdr"><h2><span class="icon">&#9881;</span> Cross-Pipeline Analysis</h2></div>

  <div class="grid g2">
    <div class="card accent-purple">
      <div class="lbl">F1 Heatmap: Questions x Pipelines</div>
      <div id="heatmap-container" style="overflow-x:auto;margin-top:8px"></div>
    </div>
    <div class="card accent-cyan">
      <div class="lbl">Category Performance Radar</div>
      <div class="chart-wrap chart-md"><canvas id="chart-radar"></canvas></div>
    </div>
  </div>

  <div class="section-hdr"><h2><span class="icon">&#10003;</span> Overlap Matrix: Which questions pass across pipelines?</h2></div>
  <div class="card" id="overlap-matrix"></div>

  <div class="section-hdr"><h2><span class="icon">&#9888;</span> Failure Patterns</h2></div>
  <div class="grid g2">
    <div class="card accent-red">
      <div class="lbl">Top Failing Question Categories</div>
      <div class="chart-wrap chart-md"><canvas id="chart-fail-cats"></canvas></div>
    </div>
    <div class="card accent-yellow">
      <div class="lbl">Error vs Timeout vs Wrong Answer</div>
      <div class="chart-wrap chart-md"><canvas id="chart-error-types"></canvas></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- TAB: KNOWLEDGE GRAPH -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-graph">
  <div class="section-hdr"><h2><span class="icon">&#9670;</span> Neo4j Knowledge Graph Stats</h2></div>
  <div class="grid g3" id="graph-kpis"></div>

  <div class="grid g2" style="margin-top:16px">
    <div class="card accent-purple">
      <div class="lbl">Entity Types Distribution</div>
      <div class="chart-wrap chart-md"><canvas id="chart-entity-types"></canvas></div>
    </div>
    <div class="card accent-cyan">
      <div class="lbl">Relationship Types</div>
      <div class="chart-wrap chart-md"><canvas id="chart-rel-types"></canvas></div>
    </div>
  </div>

  <div class="section-hdr"><h2><span class="icon">&#9776;</span> Community Summaries</h2></div>
  <div class="grid g3" id="community-cards"></div>
</div>

<div class="footer">
  RAG Benchmark Dashboard — SOTA 2026 | <code>docs/data.json</code> |
  Auto-refresh <span id="footer-timer">5s</span> |
  <span id="footer-time"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
// ============================================================
// STATE
// ============================================================
let DATA = null, charts = {}, lastHash = '', activeTab = 'overview';
const REFRESH_MS = 5000;
const TARGETS = {standard:.85,graph:.70,quantitative:.85,orchestrator:.70};
const PIPE_COLORS = {standard:'#3b82f6',graph:'#a855f7',quantitative:'#22c55e',orchestrator:'#f97316'};
const PIPE_LABELS = {standard:'STANDARD',graph:'GRAPH',quantitative:'QUANTITATIVE',orchestrator:'ORCHESTRATOR'};

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const panel = document.getElementById('panel-' + t.dataset.tab);
    if (panel) panel.classList.add('active');
    activeTab = t.dataset.tab;
    if (DATA) render();
  });
});

// ============================================================
// DATA
// ============================================================
async function fetchData() {
  try {
    const r = await fetch('data.json?t=' + Date.now());
    if (!r.ok) throw new Error(r.status);
    const json = await r.json();
    const h = JSON.stringify(json.meta) + JSON.stringify(json.pipelines);
    if (h !== lastHash) { lastHash = h; DATA = json; render(); }
    byId('live-dot').style.background = 'var(--gn)';
    byId('status-badge').className = 'tag t-ok';
    byId('status-badge').textContent = (DATA.meta.status || 'LIVE').toUpperCase();
  } catch(e) {
    byId('live-dot').style.background = 'var(--rd)';
    byId('status-badge').className = 'tag t-er';
    byId('status-badge').textContent = 'OFFLINE';
  }
  byId('last-update').textContent = new Date().toLocaleTimeString();
  byId('footer-time').textContent = new Date().toLocaleString();
}

// ============================================================
// HELPERS
// ============================================================
const byId = id => document.getElementById(id);
function wilsonCI(p,n,z=1.96){if(!n)return[0,0];const d=1+z*z/n,c=(p+z*z/(2*n))/d,s=z*Math.sqrt((p*(1-p)+z*z/(4*n))/n)/d;return[Math.max(0,c-s),Math.min(1,c+s)]}
function fmt(n,d=1){return typeof n==='number'?n.toFixed(d):'—'}
function fmtMs(ms){return ms?(ms/1000).toFixed(1)+'s':'—'}
function fmtDur(ms){if(!ms||ms<=0)return'—';const s=Math.round(ms/1000);if(s<60)return s+'s';const m=Math.floor(s/60);if(m<60)return m+'m '+s%60+'s';return Math.floor(m/60)+'h '+m%60+'m'}
function fmtCost(v){if(!v)return'$0.00';if(v<0.01)return'$'+v.toFixed(5);if(v<1)return'$'+v.toFixed(4);return'$'+v.toFixed(2)}
function pipeClass(t){return{standard:'pipe-std',graph:'pipe-graph',quantitative:'pipe-quant',orchestrator:'pipe-orch'}[t]||'pipe-std'}
function accColor(a){return a>=.7?'var(--gn)':a>=.5?'var(--yl)':'var(--rd)'}
function destroyChart(key){if(charts[key]){charts[key].destroy();delete charts[key]}}
function chartDefaults(){return{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8896a8',boxWidth:10,font:{size:11}}}},scales:{x:{grid:{color:'rgba(42,48,64,.5)'},ticks:{color:'#5a6578',font:{size:10}}},y:{grid:{color:'rgba(42,48,64,.5)'},ticks:{color:'#5a6578',font:{size:10}}}}}}

// ============================================================
// RENDER
// ============================================================
function render() {
  if (!DATA) return;
  renderOverview();
  if (activeTab === 'pipelines') renderPipelines();
  if (activeTab === 'questions') renderQuestions();
  if (activeTab === 'costs') renderCosts();
  if (activeTab === 'cross') renderCross();
  if (activeTab === 'graph') renderGraph();
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  const m = DATA.meta, p = DATA.pipelines;
  const totalTested = Object.values(p).reduce((s,v)=>s+(v.tested||0),0);
  const totalCorrect = Object.values(p).reduce((s,v)=>s+(v.correct||0),0);
  const totalErrors = Object.values(p).reduce((s,v)=>s+(v.errors||0),0);
  const overallAcc = totalTested>0?totalCorrect/totalTested:0;
  const totalCost = Object.values(p).reduce((s,v)=>s+(v.cost_usd||0),0)+(m.total_cost_usd||0);
  const avgLats = Object.values(p).filter(v=>v.avg_latency_ms).map(v=>v.avg_latency_ms);
  const avgLat = avgLats.length?avgLats.reduce((a,b)=>a+b,0)/avgLats.length:0;

  byId('kpi-row').innerHTML = `
    <div class="card accent-blue"><div class="lbl">Questions Tested</div><div class="val" style="color:var(--ac)">${totalTested}</div><div class="sub">of ${m.total_questions_in_datasets||1200} in datasets</div></div>
    <div class="card accent-${overallAcc>=.65?'green':overallAcc>=.45?'yellow':'red'}"><div class="lbl">Overall Accuracy</div><div class="val" style="color:${accColor(overallAcc)}">${(overallAcc*100).toFixed(1)}%</div><div class="sub">${totalCorrect} correct / ${totalErrors} errors</div></div>
    <div class="card accent-cyan"><div class="lbl">Testable</div><div class="val" style="color:var(--cy)">${m.total_testable||200}</div><div class="sub">${Math.max(0,(m.total_testable||200)-totalTested)} remaining</div></div>
    <div class="card accent-yellow"><div class="lbl">Avg Latency</div><div class="val mono">${fmtMs(avgLat)}</div><div class="sub">${avgLat>0?fmt(60000/avgLat,1)+' q/min':'—'}</div></div>
    <div class="card accent-green"><div class="lbl">Total Cost</div><div class="val mono">${fmtCost(totalCost)}</div><div class="sub">${totalTested>0?fmtCost(totalCost/totalTested)+'/q':'—'}</div></div>
  `;

  // Pipeline cards
  byId('pipeline-cards').innerHTML = Object.entries(p).map(([name,d]) => {
    const acc = d.tested>0?d.correct/d.tested:0;
    const target = TARGETS[name]||.7;
    const gap = acc - target;
    const errRate = d.tested>0?d.errors/d.tested:0;
    const fillW = Math.min(100, acc*100);
    const targetPos = Math.min(100, target*100);
    return `<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span class="pipe-badge ${pipeClass(name)}">${PIPE_LABELS[name]}</span>
        <span class="delta ${gap>=0?'delta-up':'delta-dn'}">${gap>=0?'+':''}${(gap*100).toFixed(1)}%</span>
      </div>
      <div style="font-size:2em;font-weight:700;color:${accColor(acc)};margin:4px 0">${(acc*100).toFixed(1)}%</div>
      <div class="accuracy-bar">
        <div class="fill" style="width:${fillW}%;background:${PIPE_COLORS[name]}"></div>
        <div class="target" style="left:${targetPos}%" title="Target: ${(target*100)}%"></div>
        <div class="label" style="color:${acc>=target?'var(--gn)':'var(--rd)'}">target ${(target*100)}%</div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:.78em;color:var(--tx2)">
        <span>${d.tested}/${d.total_questions||50} tested</span>
        <span>${fmtMs(d.avg_latency_ms)} avg</span>
        <span style="color:${errRate>.1?'var(--rd)':'var(--tx2)'}">${d.errors} errors</span>
      </div>
    </div>`;
  }).join('');

  // Accuracy chart
  const hist = DATA.history || [];
  if (hist.length > 0) {
    destroyChart('accuracy');
    const opts = chartDefaults();
    opts.scales.y.min = 0; opts.scales.y.max = 100;
    charts.accuracy = new Chart(byId('chart-accuracy'), {
      type:'line', data:{
        labels:hist.map(h=>h.event||new Date(h.timestamp).toLocaleDateString()),
        datasets:Object.entries(PIPE_COLORS).map(([k,c])=>({label:PIPE_LABELS[k],data:hist.map(h=>h[k]||null),borderColor:c,backgroundColor:c+'20',tension:.3,pointRadius:4,pointHoverRadius:6,fill:false}))
      }, options:opts
    });
  }

  // Latency chart
  destroyChart('latency');
  const latOpts = chartDefaults();
  charts.latency = new Chart(byId('chart-latency'), {
    type:'bar', data:{
      labels:Object.keys(p).map(k=>PIPE_LABELS[k]),
      datasets:[
        {label:'Avg',data:Object.values(p).map(v=>v.avg_latency_ms||0),backgroundColor:Object.keys(p).map(k=>PIPE_COLORS[k]+'cc'),borderRadius:4},
        {label:'P95',data:Object.values(p).map(v=>v.p95_latency_ms||0),backgroundColor:Object.keys(p).map(k=>PIPE_COLORS[k]+'44'),borderRadius:4}
      ]
    }, options:latOpts
  });

  // Alerts
  const alerts = [];
  const untestable = (m.total_questions_in_datasets||1200)-(m.total_testable||200);
  if (untestable>0) alerts.push({type:'danger',icon:'&#9888;',title:`${untestable} questions missing DB data`,body:'HuggingFace ingestion required to make all 1,200 questions testable.'});
  for (const [name,d] of Object.entries(p)) {
    if (d.errors>d.tested*.2) alerts.push({type:'danger',icon:'&#9888;',title:`${name.toUpperCase()}: ${d.errors} errors (${(d.errors/d.tested*100).toFixed(0)}%)`,body:'High error rate indicates timeouts or HTTP failures. Check n8n workflow execution logs.'});
    if (d.tested>0) {
      const acc=d.correct/d.tested;
      const target=TARGETS[name]||.7;
      if (acc<target-.15) alerts.push({type:'warning',icon:'&#9679;',title:`${name.toUpperCase()}: ${(acc*100).toFixed(1)}% accuracy (target ${(target*100)}%)`,body:`Gap of ${((target-acc)*100).toFixed(1)}% — see improvement roadmap in CLAUDE.md`});
    }
  }
  if (!alerts.length) alerts.push({type:'success',icon:'&#10003;',title:'All systems operational',body:'No critical alerts.'});
  byId('alerts').innerHTML = alerts.map(a=>`<div class="alert alert-${a.type}"><span class="alert-icon">${a.icon}</span><div><strong>${a.title}</strong><div class="alert-body">${a.body}</div></div></div>`).join('');

  // DB cards
  const db = DATA.databases || {};
  byId('db-cards').innerHTML = `
    <div class="card accent-blue"><div class="lbl">Pinecone (Vectors)</div><div class="val" style="color:var(--ac)">${(db.pinecone?.total_vectors||0).toLocaleString()}</div><div class="sub">${Object.keys(db.pinecone?.namespaces||{}).length} namespaces</div><div style="margin-top:8px;font-size:.75em;color:var(--tx3);max-height:120px;overflow-y:auto">${Object.entries(db.pinecone?.namespaces||{}).map(([k,v])=>`<div style="display:flex;justify-content:space-between"><span>${k||'(default)'}</span><span class="mono">${v}</span></div>`).join('')}</div></div>
    <div class="card accent-purple"><div class="lbl">Neo4j (Graph)</div><div class="val" style="color:var(--pp)">${db.neo4j?.total_nodes||0}</div><div class="sub">${db.neo4j?.total_relationships||0} relationships</div><div style="margin-top:8px;font-size:.75em;color:var(--tx3);max-height:120px;overflow-y:auto">${Object.entries(db.neo4j?.labels||{}).map(([k,v])=>`<div style="display:flex;justify-content:space-between"><span>${k}</span><span class="mono">${v}</span></div>`).join('')}</div></div>
    <div class="card accent-green"><div class="lbl">Supabase (SQL)</div><div class="val" style="color:var(--gn)">${db.supabase?.total_rows||0}</div><div class="sub">${Object.keys(db.supabase?.tables||{}).length} tables</div><div style="margin-top:8px;font-size:.75em;color:var(--tx3)">${Object.entries(db.supabase?.tables||{}).map(([k,v])=>`<div style="display:flex;justify-content:space-between"><span>${k}</span><span class="mono">${v}</span></div>`).join('')}</div></div>
  `;
}

// ============================================================
// PIPELINES TAB
// ============================================================
function renderPipelines() {
  const p = DATA.pipelines;
  const qs = DATA.questions || [];
  const tbody = document.querySelector('#pipeline-table tbody');
  tbody.innerHTML = '';
  for (const [name,d] of Object.entries(p)) {
    const acc=d.tested>0?d.correct/d.tested:0;
    const target=TARGETS[name]||.7;
    const [lo,hi]=wilsonCI(acc,d.tested);
    const errRate=d.tested>0?d.errors/d.tested:0;
    const typeQs=qs.filter(q=>q.rag_type===name);
    const f1Mean=typeQs.length?typeQs.reduce((s,q)=>s+(q.f1||0),0)/typeQs.length:0;
    const gap=acc-target;
    tbody.innerHTML+=`<tr>
      <td><span class="pipe-badge ${pipeClass(name)}">${PIPE_LABELS[name]}</span></td>
      <td><div class="bar" style="width:120px"><div class="fill-ac" style="width:${d.tested/(d.total_questions||50)*100}%"></div></div><span class="mono" style="font-size:.72em;margin-left:4px">${d.tested}/${d.total_questions||50}</span></td>
      <td style="color:${accColor(acc)};font-weight:700">${(acc*100).toFixed(1)}%</td>
      <td><span class="delta ${gap>=0?'delta-up':'delta-dn'}">${gap>=0?'+':''}${(gap*100).toFixed(1)}%</span></td>
      <td class="mono" style="font-size:.78em">${(lo*100).toFixed(1)}% — ${(hi*100).toFixed(1)}%</td>
      <td style="color:${errRate>.1?'var(--rd)':''}">${d.errors} <span style="color:var(--tx3)">(${(errRate*100).toFixed(0)}%)</span></td>
      <td class="mono">${fmtMs(d.avg_latency_ms)}</td>
      <td class="mono">${fmtMs(d.p95_latency_ms)}</td>
      <td class="mono" style="color:${f1Mean>.3?'var(--gn)':f1Mean>.1?'var(--yl)':'var(--rd)'}">${f1Mean.toFixed(3)}</td>
      <td class="mono">${fmtCost(d.cost_usd||0)}</td>
    </tr>`;
  }

  // Accuracy vs target chart
  destroyChart('accTarget');
  const accOpts = chartDefaults();
  accOpts.scales.y.min = 0; accOpts.scales.y.max = 100;
  accOpts.indexAxis = 'y';
  charts.accTarget = new Chart(byId('chart-acc-target'), {
    type:'bar', data:{
      labels:Object.keys(p).map(k=>PIPE_LABELS[k]),
      datasets:[
        {label:'Accuracy',data:Object.entries(p).map(([k,v])=>v.tested>0?(v.correct/v.tested*100):0),backgroundColor:Object.keys(p).map(k=>PIPE_COLORS[k]),borderRadius:4},
        {label:'Target',data:Object.keys(p).map(k=>(TARGETS[k]||.7)*100),backgroundColor:'rgba(255,255,255,.08)',borderColor:'var(--tx3)',borderWidth:1,borderRadius:4}
      ]
    }, options:accOpts
  });

  // Error chart
  destroyChart('errors');
  charts.errors = new Chart(byId('chart-errors'), {
    type:'doughnut', data:{
      labels:Object.keys(p).map(k=>PIPE_LABELS[k]),
      datasets:[{data:Object.values(p).map(v=>v.errors||0),backgroundColor:Object.keys(p).map(k=>PIPE_COLORS[k]),borderWidth:0}]
    }, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8896a8',boxWidth:10}}}}
  });

  // F1 distribution
  destroyChart('f1Dist');
  const bins = [0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1.0];
  const datasets = Object.entries(PIPE_COLORS).map(([k,c]) => {
    const typeQs = qs.filter(q=>q.rag_type===k);
    const counts = bins.slice(0,-1).map((_,i)=>typeQs.filter(q=>(q.f1||0)>=bins[i]&&(q.f1||0)<bins[i+1]).length);
    return {label:PIPE_LABELS[k],data:counts,backgroundColor:c+'88',borderColor:c,borderWidth:1};
  });
  charts.f1Dist = new Chart(byId('chart-f1-dist'), {
    type:'bar', data:{labels:bins.slice(0,-1).map((b,i)=>`${b.toFixed(1)}-${bins[i+1].toFixed(1)}`),datasets},
    options:{...chartDefaults(),plugins:{legend:{labels:{color:'#8896a8',boxWidth:10}}}}
  });

  // Latency vs accuracy scatter
  destroyChart('latAcc');
  const scatterData = Object.entries(p).map(([k,v])=>({
    label:PIPE_LABELS[k],
    data:[{x:v.avg_latency_ms||0,y:v.tested>0?v.correct/v.tested*100:0}],
    backgroundColor:PIPE_COLORS[k],pointRadius:10,pointHoverRadius:14
  }));
  const scOpts = chartDefaults();
  scOpts.scales.x.title = {display:true,text:'Avg Latency (ms)',color:'#5a6578'};
  scOpts.scales.y.title = {display:true,text:'Accuracy %',color:'#5a6578'};
  scOpts.scales.y.min = 0; scOpts.scales.y.max = 100;
  charts.latAcc = new Chart(byId('chart-lat-acc'), {type:'scatter',data:{datasets:scatterData},options:scOpts});
}

// ============================================================
// QUESTIONS EXPLORER
// ============================================================
function renderQuestions() {
  const qs = DATA.questions || [];
  const typeF = byId('filter-type').value;
  const statusF = byId('filter-status').value;
  const f1F = byId('filter-f1').value;
  const searchF = byId('filter-search').value.toLowerCase();

  let filtered = qs;
  if (typeF) filtered = filtered.filter(q=>q.rag_type===typeF);
  if (statusF==='correct') filtered=filtered.filter(q=>q.correct);
  else if (statusF==='incorrect') filtered=filtered.filter(q=>!q.correct&&!q.error);
  else if (statusF==='error') filtered=filtered.filter(q=>q.error);
  if (f1F==='high') filtered=filtered.filter(q=>(q.f1||0)>.5);
  else if (f1F==='medium') filtered=filtered.filter(q=>(q.f1||0)>=.1&&(q.f1||0)<=.5);
  else if (f1F==='low') filtered=filtered.filter(q=>(q.f1||0)>0&&(q.f1||0)<.1);
  else if (f1F==='zero') filtered=filtered.filter(q=>!q.f1||q.f1===0);
  if (searchF) filtered=filtered.filter(q=>(q.question||'').toLowerCase().includes(searchF)||(q.id||'').toLowerCase().includes(searchF));

  byId('feed-count').textContent = filtered.length;

  const feed = byId('question-feed');
  feed.innerHTML = filtered.slice(-300).reverse().map((q,i) => {
    const st = q.error?'<span class="tag t-er">ERR</span>':q.correct?'<span class="tag t-ok">OK</span>':'<span class="tag t-wr">FAIL</span>';
    const f1Color = (q.f1||0)>.4?'var(--gn)':(q.f1||0)>.1?'var(--yl)':'var(--rd)';
    return `<div class="feed-row expandable feed-7" onclick="toggleDetail(this)">
      <div class="mono" style="font-size:.78em">${q.id||'?'}</div>
      <div><span class="pipe-badge ${pipeClass(q.rag_type)}">${(q.rag_type||'?').slice(0,5).toUpperCase()}</span></div>
      <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(q.question||'').replace(/"/g,'&quot;')}">${q.question||'—'}</div>
      <div class="mono" style="color:${f1Color}">F1:${(q.f1||0).toFixed(2)}</div>
      <div class="mono">${q.latency_ms?(q.latency_ms/1000).toFixed(1)+'s':'—'}</div>
      <div style="font-size:.72em;color:var(--tx3)">${q.match_type||'—'}</div>
      <div>${st}</div>
    </div>
    <div class="feed-detail" id="detail-${i}">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><strong style="color:var(--tx2)">Expected:</strong><br>${q.expected||'—'}</div>
        <div><strong style="color:var(--tx2)">Answer:</strong><br>${q.answer||'—'}</div>
      </div>
      ${q.error?'<div style="margin-top:8px;color:var(--rd)"><strong>Error:</strong> '+q.error+'</div>':''}
    </div>`;
  }).join('');

  // Feed stats
  const correct = filtered.filter(q=>q.correct).length;
  const errors = filtered.filter(q=>q.error).length;
  const avgF1 = filtered.length?filtered.reduce((s,q)=>s+(q.f1||0),0)/filtered.length:0;
  const avgLat = filtered.filter(q=>q.latency_ms).length?filtered.filter(q=>q.latency_ms).reduce((s,q)=>s+q.latency_ms,0)/filtered.filter(q=>q.latency_ms).length:0;
  byId('feed-stats').innerHTML = `
    <div class="card"><div class="lbl">Filtered</div><div class="val">${filtered.length}</div></div>
    <div class="card"><div class="lbl">Accuracy</div><div class="val" style="color:${accColor(filtered.length?correct/filtered.length:0)}">${filtered.length?(correct/filtered.length*100).toFixed(1)+'%':'—'}</div></div>
    <div class="card"><div class="lbl">Mean F1</div><div class="val mono">${avgF1.toFixed(3)}</div></div>
    <div class="card"><div class="lbl">Avg Latency</div><div class="val mono">${fmtMs(avgLat)}</div></div>
  `;
}

function toggleDetail(row) {
  const detail = row.nextElementSibling;
  if (detail) detail.classList.toggle('open');
}

// ============================================================
// COSTS TAB
// ============================================================
function renderCosts() {
  const p = DATA.pipelines, m = DATA.meta;
  const totalTested = Object.values(p).reduce((s,v)=>s+(v.tested||0),0);
  const totalCost = Object.values(p).reduce((s,v)=>s+(v.cost_usd||0),0)+(m.total_cost_usd||0);
  const avgLats = Object.values(p).filter(v=>v.avg_latency_ms).map(v=>v.avg_latency_ms);
  const avgLat = avgLats.length?avgLats.reduce((a,b)=>a+b,0)/avgLats.length:0;
  const remaining = (m.total_testable||200)-totalTested;

  // Estimated costs per pipeline (based on typical token usage)
  const estCosts = {
    standard: {embed:0.00001, pinecone:0, llm:0.00015, total:0.00016},
    graph: {hyde:0.00012, neo4j:0, rerank:0.00003, llm:0.00015, total:0.00030},
    quantitative: {sql:0.00008, supabase:0, llm:0.00012, total:0.00020},
    orchestrator: {intent:0.00008, sub:0.00050, merge:0.00015, total:0.00073}
  };

  byId('cost-kpis').innerHTML = `
    <div class="card accent-green"><div class="lbl">Total Recorded Cost</div><div class="val mono">${fmtCost(totalCost)}</div><div class="sub">${totalCost>0?'from API tracking':'not yet tracked'}</div></div>
    <div class="card accent-blue"><div class="lbl">Est. Cost (200 questions)</div><div class="val mono">$${(Object.entries(estCosts).reduce((s,[k,v])=>{const d=p[k];return s+(d?.tested||0)*v.total},0)).toFixed(4)}</div><div class="sub">based on token estimates</div></div>
    <div class="card accent-cyan"><div class="lbl">Est. Cost per Question</div><div class="val mono">$${(Object.values(estCosts).reduce((s,v)=>s+v.total,0)/4).toFixed(5)}</div><div class="sub">average across pipelines</div></div>
    <div class="card accent-yellow"><div class="lbl">Projected 1,200q Cost</div><div class="val mono">$${(1200*Object.values(estCosts).reduce((s,v)=>s+v.total,0)/4).toFixed(2)}</div><div class="sub">full evaluation estimate</div></div>
  `;

  // Cost breakdown card
  byId('cost-breakdown').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      ${Object.entries(estCosts).map(([name,costs])=>`
        <div>
          <div style="margin-bottom:8px"><span class="pipe-badge ${pipeClass(name)}">${PIPE_LABELS[name]}</span> <span class="mono" style="color:var(--tx2)">${fmtCost(costs.total)}/q</span></div>
          ${Object.entries(costs).filter(([k])=>k!=='total').map(([k,v])=>`
            <div class="cost-item">
              <div class="cost-label"><div class="cost-dot" style="background:${PIPE_COLORS[name]}"></div>${k}</div>
              <div class="cost-val mono">${fmtCost(v)}</div>
            </div>
          `).join('')}
        </div>
      `).join('')}
    </div>
  `;

  // Resource cards
  byId('resource-cards').innerHTML = `
    <div class="card"><div class="lbl">Throughput</div><div class="val">${avgLat>0?fmt(60000/avgLat,1):'—'}</div><div class="sub">questions/min (avg)</div></div>
    <div class="card"><div class="lbl">Est. Time Remaining</div><div class="val mono">${fmtDur(remaining*avgLat)}</div><div class="sub">${remaining} questions left</div></div>
    <div class="card"><div class="lbl">Full Eval Est.</div><div class="val mono">${fmtDur(1200*(avgLat||6000))}</div><div class="sub">1,200 questions total</div></div>
  `;

  // Cost pie
  destroyChart('costPie');
  charts.costPie = new Chart(byId('chart-cost-pie'), {
    type:'doughnut', data:{
      labels:Object.keys(estCosts).map(k=>PIPE_LABELS[k]),
      datasets:[{data:Object.entries(estCosts).map(([k,v])=>(p[k]?.tested||0)*v.total),backgroundColor:Object.keys(estCosts).map(k=>PIPE_COLORS[k]),borderWidth:0}]
    }, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8896a8',boxWidth:10}}}}
  });

  // Cost per question bar
  destroyChart('costPerQ');
  charts.costPerQ = new Chart(byId('chart-cost-per-q'), {
    type:'bar', data:{
      labels:Object.keys(estCosts).map(k=>PIPE_LABELS[k]),
      datasets:[{label:'Est. $/question',data:Object.values(estCosts).map(v=>v.total*1000),backgroundColor:Object.keys(estCosts).map(k=>PIPE_COLORS[k]+'cc'),borderRadius:4}]
    }, options:{...chartDefaults(),scales:{...chartDefaults().scales,y:{...chartDefaults().scales.y,title:{display:true,text:'Cost (x$0.001)',color:'#5a6578'}}}}
  });
}

// ============================================================
// CROSS-ANALYSIS TAB
// ============================================================
function renderCross() {
  const qs = DATA.questions || [];
  if (!qs.length) {
    byId('heatmap-container').innerHTML = '<div style="color:var(--tx3);padding:20px">No question data available. Run an evaluation first.</div>';
    return;
  }

  // Group questions by base ID (strip prefix)
  const byBase = {};
  qs.forEach(q => {
    const base = (q.question||'').toLowerCase().trim();
    if (!byBase[base]) byBase[base] = {};
    byBase[base][q.rag_type] = q;
  });

  // Overlap matrix
  const pipes = ['standard','graph','quantitative','orchestrator'];
  const matrix = pipes.map(a => pipes.map(b => {
    if (a===b) return {both:0,total:0};
    let both=0, total=0;
    qs.filter(q=>q.rag_type===a).forEach(qa => {
      const match = qs.find(qb=>qb.rag_type===b && qb.question===qa.question);
      if (match) { total++; if (qa.correct && match.correct) both++; }
    });
    return {both,total};
  }));

  byId('overlap-matrix').innerHTML = `<table style="font-size:.82em">
    <tr><th></th>${pipes.map(p=>`<th><span class="pipe-badge ${pipeClass(p)}">${PIPE_LABELS[p]}</span></th>`).join('')}</tr>
    ${pipes.map((a,i)=>`<tr><td><span class="pipe-badge ${pipeClass(a)}">${PIPE_LABELS[a]}</span></td>${pipes.map((b,j)=>{
      if (i===j){const d=DATA.pipelines[a];return`<td class="mono" style="background:${PIPE_COLORS[a]}22">${d?.correct||0}/${d?.tested||0}</td>`}
      const m=matrix[i][j];return`<td class="mono">${m.total?m.both+'/'+m.total:'—'}</td>`;
    }).join('')}</tr>`).join('')}
  </table>`;

  // Category performance
  const categories = {};
  qs.forEach(q => {
    const cat = q.match_type || 'unknown';
    if (!categories[cat]) categories[cat] = {total:0,correct:0};
    categories[cat].total++;
    if (q.correct) categories[cat].correct++;
  });

  // Failure patterns chart
  destroyChart('failCats');
  const failData = Object.entries(categories).sort((a,b)=>(a[1].correct/a[1].total)-(b[1].correct/b[1].total)).slice(0,10);
  charts.failCats = new Chart(byId('chart-fail-cats'), {
    type:'bar', data:{
      labels:failData.map(([k])=>k),
      datasets:[
        {label:'Correct',data:failData.map(([,v])=>v.correct),backgroundColor:'var(--gn)',borderRadius:4},
        {label:'Wrong',data:failData.map(([,v])=>v.total-v.correct),backgroundColor:'var(--rd)',borderRadius:4}
      ]
    }, options:{...chartDefaults(),scales:{...chartDefaults().scales,x:{...chartDefaults().scales.x,stacked:true},y:{...chartDefaults().scales.y,stacked:true}}}
  });

  // Error types chart
  destroyChart('errorTypes');
  const errorTypes = {};
  pipes.forEach(name => {
    const pqs = qs.filter(q=>q.rag_type===name);
    errorTypes[name] = {
      correct: pqs.filter(q=>q.correct).length,
      wrong: pqs.filter(q=>!q.correct&&!q.error).length,
      error: pqs.filter(q=>q.error).length
    };
  });
  charts.errorTypes = new Chart(byId('chart-error-types'), {
    type:'bar', data:{
      labels:pipes.map(k=>PIPE_LABELS[k]),
      datasets:[
        {label:'Correct',data:pipes.map(k=>errorTypes[k]?.correct||0),backgroundColor:'var(--gn)',borderRadius:4},
        {label:'Wrong Answer',data:pipes.map(k=>errorTypes[k]?.wrong||0),backgroundColor:'var(--yl)',borderRadius:4},
        {label:'Error/Timeout',data:pipes.map(k=>errorTypes[k]?.error||0),backgroundColor:'var(--rd)',borderRadius:4}
      ]
    }, options:{...chartDefaults(),scales:{...chartDefaults().scales,x:{...chartDefaults().scales.x,stacked:true},y:{...chartDefaults().scales.y,stacked:true}}}
  });

  // Radar chart
  destroyChart('radar');
  const radarLabels = ['Accuracy','F1 Score','Speed','Reliability','Coverage'];
  const radarData = pipes.map(name => {
    const d = DATA.pipelines[name];
    const pqs = qs.filter(q=>q.rag_type===name);
    const acc = d.tested>0?d.correct/d.tested*100:0;
    const f1 = pqs.length?pqs.reduce((s,q)=>s+(q.f1||0),0)/pqs.length*100:0;
    const speed = d.avg_latency_ms?Math.max(0,100-d.avg_latency_ms/150):0;
    const reliability = d.tested>0?(1-d.errors/d.tested)*100:0;
    const coverage = d.tested/(d.total_questions||50)*100;
    return {label:PIPE_LABELS[name],data:[acc,f1*5,speed,reliability,coverage],borderColor:PIPE_COLORS[name],backgroundColor:PIPE_COLORS[name]+'22',pointBackgroundColor:PIPE_COLORS[name]};
  });
  charts.radar = new Chart(byId('chart-radar'), {
    type:'radar', data:{labels:radarLabels,datasets:radarData},
    options:{responsive:true,maintainAspectRatio:false,scales:{r:{min:0,max:100,grid:{color:'rgba(42,48,64,.5)'},angleLines:{color:'rgba(42,48,64,.5)'},pointLabels:{color:'#8896a8'},ticks:{display:false}}},plugins:{legend:{labels:{color:'#8896a8',boxWidth:10}}}}
  });
}

// ============================================================
// KNOWLEDGE GRAPH TAB
// ============================================================
function renderGraph() {
  const db = DATA.databases?.neo4j || {};
  const labels = db.labels || {};
  const totalNodes = db.total_nodes || 0;
  const totalRels = db.total_relationships || 0;

  byId('graph-kpis').innerHTML = `
    <div class="card accent-purple"><div class="lbl">Total Entities</div><div class="val" style="color:var(--pp)">${totalNodes}</div><div class="sub">${Object.keys(labels).length} entity types</div></div>
    <div class="card accent-cyan"><div class="lbl">Total Relationships</div><div class="val" style="color:var(--cy)">${totalRels}</div><div class="sub">11 relationship types</div></div>
    <div class="card accent-blue"><div class="lbl">Graph Density</div><div class="val mono">${totalNodes>0?(totalRels/totalNodes).toFixed(1):'—'}</div><div class="sub">edges per node</div></div>
  `;

  // Entity types chart
  destroyChart('entityTypes');
  const sortedLabels = Object.entries(labels).sort((a,b)=>b[1]-a[1]);
  const entityColors = ['#3b82f6','#a855f7','#22c55e','#f97316','#06b6d4','#ec4899','#eab308','#ef4444','#8b5cf6','#14b8a6'];
  charts.entityTypes = new Chart(byId('chart-entity-types'), {
    type:'doughnut', data:{
      labels:sortedLabels.map(([k])=>k),
      datasets:[{data:sortedLabels.map(([,v])=>v),backgroundColor:sortedLabels.map((_,i)=>entityColors[i%entityColors.length]),borderWidth:0}]
    }, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#8896a8',boxWidth:10,font:{size:10}}}}}
  });

  // Relationship types chart (static data from the populate script)
  destroyChart('relTypes');
  const relTypes = {CONNECTE:93,A_CREE:19,ETUDIE:17,UTILISE:8,PROTEGE_CONTRE:5,CIBLE:4,SOUS_ENSEMBLE_DE:2,ETEND:2,VISE_A_LIMITER:1};
  charts.relTypes = new Chart(byId('chart-rel-types'), {
    type:'bar', data:{
      labels:Object.keys(relTypes),
      datasets:[{label:'Count',data:Object.values(relTypes),backgroundColor:'var(--pp)',borderRadius:4}]
    }, options:{...chartDefaults(),indexAxis:'y'}
  });

  // Community summaries
  const communities = [
    {id:'comm-science-01',title:'Scientific Pioneers & Nobel Laureates',entities:27,score:.95},
    {id:'comm-tech-01',title:'Computing Pioneers & AI',entities:21,score:.92},
    {id:'comm-inventors-01',title:'Electrical Pioneers & Innovation',entities:12,score:.88},
    {id:'comm-politics-01',title:'World Leaders & Politics',entities:13,score:.85},
    {id:'comm-arts-01',title:'Artists, Writers & Culture',entities:22,score:.90},
    {id:'comm-space-01',title:'Space & Nuclear Research',entities:14,score:.87},
    {id:'comm-health-01',title:'Global Health & Disease',entities:19,score:.91},
    {id:'comm-film-01',title:'Film Directors & Cinema',entities:8,score:.75},
    {id:'comm-edu-01',title:'Universities & Research',entities:18,score:.83},
  ];
  byId('community-cards').innerHTML = communities.map(c => `
    <div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div class="lbl">${c.title}</div><span class="mono" style="color:var(--pp)">${c.score.toFixed(2)}</span></div>
    <div style="margin-top:6px;font-size:.82em;color:var(--tx2)">${c.entities} entities</div>
    <div class="bar" style="margin-top:6px"><div class="fill-pp" style="width:${c.score*100}%"></div></div></div>
  `).join('');
}

// ============================================================
// CSV EXPORT
// ============================================================
byId('btn-export')?.addEventListener('click', () => {
  if (!DATA?.questions?.length) return;
  const rows = [['id','rag_type','question','expected','answer','correct','f1','latency_ms','error','match_type','cost_usd']];
  DATA.questions.forEach(q => rows.push([q.id,q.rag_type,`"${(q.question||'').replace(/"/g,'""')}"`,`"${(q.expected||'').replace(/"/g,'""')}"`,`"${(q.answer||'').replace(/"/g,'""')}"`,q.correct,q.f1,q.latency_ms,q.error||'',q.match_type||'',q.cost_usd||0]));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `rag-eval-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
});

// ============================================================
// FILTERS
// ============================================================
['filter-type','filter-status','filter-f1'].forEach(id => byId(id)?.addEventListener('change', () => activeTab==='questions'&&renderQuestions()));
byId('filter-search')?.addEventListener('input', () => activeTab==='questions'&&renderQuestions());

// ============================================================
// BOOT
// ============================================================
fetchData();
setInterval(fetchData, REFRESH_MS);
</script>
</body>
</html>
